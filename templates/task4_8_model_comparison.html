<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 4.8: Model Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .task-header { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 2rem 0; }
        .learning-objective { background: #f8f9fa; padding: 1rem; border-left: 4px solid #fa709a; }
        .model-card { border-left: 4px solid #fa709a; }
    </style>
</head>
<body>
    <div class="task-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-balance-scale me-3"></i>Task 4.8: Model Comparison</h1>
                <p class="lead mb-0">Compare multiple models side-by-side to select the best</p>
            </div>
            <a href="/level/4" class="btn btn-light">‚Üê Back to Level 4</a>
        </div>
    </div>

    <div class="container py-4">
        <div class="learning-objective mb-4">
            <h4><i class="fas fa-bullseye me-2"></i>Learning Objective</h4>
            <p class="mb-0">Train multiple models (Logistic Regression, Naive Bayes, Linear SVM) with the same data and compare their performance metrics, training time, and predictions to choose the best model for your task.</p>
        </div>

        <!-- Activity 1: Select Models to Compare -->
        <div class="card mb-4 model-card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-list-check me-2"></i>Activity 1: Select Models to Compare</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compareLogReg" checked>
                            <label class="form-check-label" for="compareLogReg">Logistic Regression</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compareNB" checked>
                            <label class="form-check-label" for="compareNB">Multinomial Naive Bayes</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="compareSVM" checked>
                            <label class="form-check-label" for="compareSVM">Linear SVM</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <label class="form-label">Text Column</label>
                    <select id="textCol" class="form-select"></select>
                </div>
                <div class="mt-3">
                    <label class="form-label">Label Column</label>
                    <select id="labelCol" class="form-select"></select>
                </div>
                <div class="mt-3">
                    <label class="form-label">Test Size: <span id="splitLabel">0.2</span></label>
                    <input type="range" min="0.1" max="0.4" step="0.05" value="0.2" class="form-range" id="split" oninput="document.getElementById('splitLabel').textContent=this.value">
                </div>
            </div>
        </div>

        <!-- Activity 2: Train All Models -->
        <div class="card mb-4 model-card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-play me-2"></i>Activity 2: Train All Selected Models</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success btn-lg" onclick="trainAllModels()"><i class="fas fa-rocket me-2"></i>Train All Models</button>
                <div id="trainingStatus" class="mt-3" style="display:none"></div>
            </div>
        </div>

        <!-- Activity 3: Comparison Table -->
        <div class="card mb-4 model-card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-table me-2"></i>Activity 3: Side-by-Side Comparison</h5>
            </div>
            <div class="card-body">
                <div id="comparisonTable" style="display:none"></div>
            </div>
        </div>

        <!-- Activity 4: Select Best Model -->
        <div class="card mb-4 model-card">
            <div class="card-header bg-warning">
                <h5><i class="fas fa-trophy me-2"></i>Activity 4: Select Best Model</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Based on your comparison, select the best model. Consider accuracy, F1-score, training time, and interpretability.</p>
                <div id="bestModelSelection" style="display:none">
                    <label class="form-label">Best Model</label>
                    <select id="bestModel" class="form-select">
                        <option value="">Select...</option>
                    </select>
                    <button class="btn btn-warning mt-3" onclick="saveBestModel()"><i class="fas fa-save me-2"></i>Save as Best Model</button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="card">
            <div class="card-body text-center">
                <a href="/level/4" class="btn btn-outline-secondary me-2">Back to Level 4</a>
                <a href="/level/4/task/7" class="btn btn-outline-primary me-2">‚Üê Previous: Hyperparameter Tuning</a>
                <a href="/level/4/task/9" class="btn btn-primary">Next: Error Analysis <i class="fas fa-arrow-right ms-2"></i></a>
            </div>
        </div>
    </div>

    <script>
        let currentProjectId = null;
        let comparisonResults = [];

        window.addEventListener('DOMContentLoaded', async () => {
            currentProjectId = localStorage.getItem('level3_project_id') || localStorage.getItem('level4_project_id');
            if (!currentProjectId) { alert('No project found'); return; }
            await populateColumns();
        });

        async function populateColumns() {
            try {
                const res = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await res.json();
                const cols = data.columns || [];
                ['textCol', 'labelCol'].forEach(id => {
                    const sel = document.getElementById(id);
                    sel.innerHTML = '<option value="">Select...</option>' + cols.map(c => `<option value="${c}">${c}</option>`).join('');
                });
            } catch(e) {}
        }

        async function trainAllModels() {
            const textCol = document.getElementById('textCol').value;
            const labelCol = document.getElementById('labelCol').value;
            const testSize = parseFloat(document.getElementById('split').value);
            const models = [];
            if (document.getElementById('compareLogReg').checked) models.push('logreg');
            if (document.getElementById('compareNB').checked) models.push('nb');
            if (document.getElementById('compareSVM').checked) models.push('linear_svm');

            if (!textCol || !labelCol || models.length === 0) { alert('Select columns and at least one model'); return; }

            document.getElementById('trainingStatus').style.display = 'block';
            document.getElementById('trainingStatus').innerHTML = '<div class="spinner-border text-primary" role="status"></div> Training models...';

            comparisonResults = [];
            for (const modelType of models) {
                try {
                    const res = await fetch(`/level/4/projects/${currentProjectId}/train-text-classifier`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            text_column: textCol,
                            label_column: labelCol,
                            test_size: testSize,
                            vectorizer_type: 'tfidf',
                            max_features: 5000,
                            ngram_min: 1,
                            ngram_max: 2,
                            model_type: modelType
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        comparisonResults.push({
                            model: modelType,
                            accuracy: data.metrics.accuracy,
                            precision: data.metrics.precision,
                            recall: data.metrics.recall,
                            f1: data.metrics.f1,
                            run_id: data.run_id
                        });
                    }
                } catch(e) {
                    console.error('Error training', modelType, e);
                }
            }

            showComparison();
        }

        function showComparison() {
            if (comparisonResults.length === 0) {
                document.getElementById('trainingStatus').innerHTML = '<div class="alert alert-warning">No results</div>';
                return;
            }

            let html = '<table class="table table-striped"><thead><tr><th>Model</th><th>Accuracy</th><th>Precision</th><th>Recall</th><th>F1-Score</th><th>Rank</th></tr></thead><tbody>';
            comparisonResults.sort((a, b) => parseFloat(b.accuracy) - parseFloat(a.accuracy));
            comparisonResults.forEach((r, i) => {
                const rank = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â';
                html += `<tr ${i === 0 ? 'class="table-success"' : ''}><td><strong>${r.model.toUpperCase()}</strong></td><td>${r.accuracy.toFixed(3)}</td><td>${r.precision.toFixed(3)}</td><td>${r.recall.toFixed(3)}</td><td>${r.f1.toFixed(3)}</td><td>${rank}</td></tr>`;
            });
            html += '</tbody></table>';

            document.getElementById('comparisonTable').innerHTML = html;
            document.getElementById('comparisonTable').style.display = 'block';

            const bestModel = document.getElementById('bestModel');
            bestModel.innerHTML = '<option value="">Select...</option>' + comparisonResults.map(r => `<option value="${r.model}">${r.model.toUpperCase()} (Acc: ${r.accuracy.toFixed(3)})</option>`).join('');
            document.getElementById('bestModelSelection').style.display = 'block';
            document.getElementById('trainingStatus').innerHTML = '<div class="alert alert-success">Training completed!</div>';
        }

        function saveBestModel() {
            const best = document.getElementById('bestModel').value;
            if (!best) { alert('Select a model'); return; }
            alert(`Best model ${best.toUpperCase()} saved! You can use this model for production deployment.`);
        }
    </script>
</body>
</html>

