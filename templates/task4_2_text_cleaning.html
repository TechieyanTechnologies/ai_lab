<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 4.2: Text Cleaning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .task-header { background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%); color: white; padding: 2rem 0; }
        .learning-objective { background: #f8f9fa; padding: 1rem; border-left: 4px solid #5b86e5; }
        .demo-area { background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; }
        .token { display: inline-block; background: #eef6ff; border: 1px solid #cfe2ff; padding: .2rem .4rem; border-radius: 4px; margin: .1rem; }
    </style>
</head>
<body>
    <div class="task-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-broom me-3"></i>Task 4.2: Text Cleaning</h1>
                <p class="lead mb-0">Hands-on cleaning: lowercase, punctuation, stopwords, tokenization</p>
            </div>
            <a href="/level/4" class="btn btn-light">← Back to Level 4</a>
        </div>
    </div>

    <div class="container py-4">
        <div class="learning-objective mb-4">
            <h4><i class="fas fa-bullseye me-2"></i>Learning Objective</h4>
            <p class="mb-0">Practice cleaning operations on sample inputs and apply them to your dataset column.</p>
        </div>

        <!-- Activity 1: Try Cleaning on Sample Text -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-wand-magic-sparkles me-2"></i>Activity 1: Clean a Sentence</h5>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">Enter text</label>
                        <input type="text" id="demoInput" class="form-control" value="This is, perhaps, the BEST movie ever!!">
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cLower" checked>
                            <label class="form-check-label" for="cLower">Lowercase</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cPunct" checked>
                            <label class="form-check-label" for="cPunct">Remove punctuation</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cStop">
                            <label class="form-check-label" for="cStop">Remove stopwords</label>
                        </div>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button class="btn btn-outline-primary" onclick="runDemo()"><i class="fas fa-play me-2"></i>Run</button>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6>Original</h6>
                        <div class="demo-area" id="origTokens"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Cleaned</h6>
                        <div class="demo-area" id="cleanTokens"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity 2: Apply to Dataset Column -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-table me-2"></i>Activity 2: Apply Cleaning to Dataset</h5>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">Text Column</label>
                        <select id="dsTextCol" class="form-select"></select>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dsLower" checked>
                            <label class="form-check-label" for="dsLower">Lowercase</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dsPunct" checked>
                            <label class="form-check-label" for="dsPunct">Remove punctuation</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dsStop">
                            <label class="form-check-label" for="dsStop">Remove stopwords</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">New Column Name</label>
                        <input type="text" id="dsNewCol" class="form-control" placeholder="e.g., text_clean">
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button class="btn btn-success" onclick="applyToDataset()"><i class="fas fa-magic me-2"></i>Clean & Save</button>
                </div>
                <div class="mt-3" id="dsCleanResult"></div>
            </div>
        </div>

        <!-- Activity 2B: Custom Stopwords & Regex Replace (Advanced) -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Activity 2B: Custom Stopwords & Regex</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Custom Stopwords (comma-separated)</label>
                        <textarea id="customStops" class="form-control" rows="3" placeholder="e.g., movie,film,good,bad"></textarea>
                        <div class="text-end mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="saveStops()"><i class="fas fa-save me-2"></i>Save Preset</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadStops()"><i class="fas fa-download me-2"></i>Load Preset</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Regex Replace</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Pattern</span>
                            <input id="regexPattern" class="form-control" placeholder="e.g., (\d+)">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">Replace</span>
                            <input id="regexReplace" class="form-control" placeholder="e.g., NUM">
                        </div>
                        <div class="form-text">Applied in the demo below (client-side) to understand impact</div>
                    </div>
                </div>
                <div class="mt-3">
                    <label class="form-label">Try it on a sentence</label>
                    <div class="input-group">
                        <input id="advInput" class="form-control" value="I watched 3 movies in 2024 and they were GOOD!">
                        <button class="btn btn-outline-primary" onclick="runAdvanced()"><i class="fas fa-play me-2"></i>Run</button>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6"><div class="demo-area" id="advBefore"></div></div>
                        <div class="col-md-6"><div class="demo-area" id="advAfter"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity 3: Token Statistics (Client-side) -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5><i class="fas fa-chart-bar me-2"></i>Activity 3: Token Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">Column for Stats</label>
                        <select id="statCol" class="form-select"></select>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-secondary" onclick="computeStats()"><i class="fas fa-calculator me-2"></i>Compute</button>
                    </div>
                </div>
                <div class="row mt-3" id="statResult"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-body text-center">
                <a href="/level/4/task/3" class="btn btn-primary">Next: Vectorization <i class="fas fa-arrow-right ms-2"></i></a>
            </div>
        </div>
    </div>

    <script>
        const STOP = new Set(['the','a','an','is','are','was','were','be','been','to','of','and','in','on','for','with','at','by','from','as','that','this','it','or','if','then','so','but']);
        let currentProjectId = null;
        let preview = null;

        window.addEventListener('DOMContentLoaded', async () => {
            currentProjectId = localStorage.getItem('level3_project_id') || localStorage.getItem('level4_project_id');
            await loadPreview();
            await populateColumns();
            runDemo();
        });

        async function loadPreview() {
            try {
                const res = await fetch(`/projects/${currentProjectId}/dataset/preview`);
                preview = await res.json();
            } catch(e) {}
        }

        async function populateColumns() {
            try {
                const res = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await res.json();
                const cols = data.columns || [];
                fill('dsTextCol', cols);
                fill('statCol', cols);
            } catch(e) {}
        }
        function fill(id, cols){ const el=document.getElementById(id); el.innerHTML=''; cols.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;el.appendChild(o);});}

        function tokenize(s){ return s.split(/\s+/).filter(Boolean); }
        function showTokens(id, s){ const box=document.getElementById(id); box.innerHTML=''; tokenize(s).forEach(t=>{ const span=document.createElement('span'); span.className='token'; span.textContent=t; box.appendChild(span); }); }

        function cleanStr(s, lower, punct, stop){
            let t=s;
            if(lower) t=t.toLowerCase();
            if(punct) t=t.replace(/[^\w\s]/g,' ').replace(/\s+/g,' ').trim();
            if(stop){ t=tokenize(t).filter(w=>!STOP.has(w)).join(' '); }
            return t;
        }

        function runDemo(){
            const s=document.getElementById('demoInput').value;
            const lower=document.getElementById('cLower').checked;
            const punct=document.getElementById('cPunct').checked;
            const stop=document.getElementById('cStop').checked;
            showTokens('origTokens', s);
            showTokens('cleanTokens', cleanStr(s, lower, punct, stop));
        }

        async function applyToDataset(){
            const textCol=document.getElementById('dsTextCol').value;
            const lower=document.getElementById('dsLower').checked;
            const punct=document.getElementById('dsPunct').checked;
            const stop=document.getElementById('dsStop').checked;
            const newCol=document.getElementById('dsNewCol').value.trim();
            try{
                const res=await fetch(`/level/4/projects/${currentProjectId}/prepare/clean`,{
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ text_column:textCol, lower, remove_punct:punct, remove_stopwords:stop, new_column:newCol||undefined })
                });
                const data=await res.json();
                if(!data.success) throw new Error(data.error||'Failed');
                document.getElementById('dsCleanResult').innerHTML=`<div class="alert alert-success">New column: <strong>${data.new_column}</strong><br>Avg length: ${data.avg_length_before.toFixed(1)} → ${data.avg_length_after.toFixed(1)}<br><a class='btn btn-sm btn-outline-primary mt-2' target='_blank' href='${data.cleaned_file}'>Download cleaned CSV</a></div>`;
                await loadPreview();
                await populateColumns();
            }catch(e){alert(e.message)}
        }

        function computeStats(){
            if(!preview||!preview.head) return;
            const col=document.getElementById('statCol').value;
            const rows=preview.head.map(r=>String(r[col]||''));
            const lengths=rows.map(r=>r.length);
            const tokens=rows.map(r=>tokenize(r));
            const tokenCounts=tokens.map(ts=>ts.length);
            const avg=(arr)=> arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length):0;
            const statHTML=`<div class='col-md-6'><div class='alert alert-info'><strong>Characters</strong><br>Avg: ${avg(lengths).toFixed(1)}</div></div>
                            <div class='col-md-6'><div class='alert alert-info'><strong>Tokens</strong><br>Avg: ${avg(tokenCounts).toFixed(1)}</div></div>`;
            document.getElementById('statResult').innerHTML=statHTML;
        }

        // Advanced activity helpers
        function saveStops(){ localStorage.setItem('l4_custom_stops', document.getElementById('customStops').value||''); }
        function loadStops(){ const v=localStorage.getItem('l4_custom_stops')||''; document.getElementById('customStops').value=v; }
        function applyRegex(s){ const pat=document.getElementById('regexPattern').value; const rep=document.getElementById('regexReplace').value; if(!pat) return s; try{ const r=new RegExp(pat,'g'); return s.replace(r, rep); }catch(e){ return s; } }
        function runAdvanced(){
            const stops=(document.getElementById('customStops').value||'').split(',').map(x=>x.trim()).filter(Boolean);
            const localStop=new Set(stops);
            const input=document.getElementById('advInput').value;
            // before tokens
            showTokens('advBefore', input);
            // regex then lowercase then remove stops
            let t=applyRegex(input).toLowerCase().replace(/[^\w\s]/g,' ').replace(/\s+/g,' ').trim();
            let out=t.split(/\s+/).filter(w=>w && !localStop.has(w) && !STOP.has(w)).join(' ');
            showTokens('advAfter', out);
        }
    </script>
</body>
</html>


