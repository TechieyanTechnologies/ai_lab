<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 11: Practice Assignments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .task-header { background: linear-gradient(135deg, #E91E63 0%, #9C27B0 100%); color: white; padding: 2rem 0; }
        .learning-objective { background: #f8f9fa; padding: 1rem; border-left: 4px solid #E91E63; }
        .assignment-card { background: #fff; border: 2px solid #E91E63; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; }
        .assignment-card h6 { color: #E91E63; font-weight: bold; }
        .assignment-card.completed { border-color: #28a745; background: #f8fff8; }
        .assignment-card.completed h6 { color: #28a745; }
        .activity-card { background: #fff; border: 2px solid #E91E63; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; }
        .activity-card h6 { color: #E91E63; font-weight: bold; }
        #assignmentResult { min-height: 200px; background: white; border: 1px solid #dee2e6; padding: 1.5rem; }
        .progress-bar { background: linear-gradient(90deg, #E91E63, #9C27B0); }
        .difficulty-badge { font-size: 0.8rem; }
        .score-display { font-size: 1.5rem; font-weight: bold; color: #E91E63; }
    </style>
</head>
<body>
    <div class="task-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
            <h1><i class="fas fa-tasks me-3"></i>Task 11: Practice Assignments</h1>
                    <p class="lead mb-0">Test your data analysis skills with hands-on exercises</p>
                </div>
                <div class="text-end">
                    <a href="/level/1" class="btn btn-light me-2">‚Üê Back to Level 1</a>
                    <span class="badge bg-light text-dark me-2" style="font-size: 0.9rem;">
                        <i class="fas fa-clock me-1"></i>45 minutes
                    </span>
                    <a href="/level/1/task/11/document" target="_blank" class="btn btn-light btn-sm">
                        <i class="fas fa-book me-2"></i>Document
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Learning Objective -->
        <div class="learning-objective mb-4">
            <h4><i class="fas fa-bullseye me-2"></i>Learning Objective</h4>
            <p class="mb-0">Apply all the data analysis skills you've learned through practical assignments. Complete exercises to test your understanding of data cleaning, visualization, analysis, and reporting.</p>
        </div>

        <!-- Progress Tracking -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-chart-line me-2"></i>Your Progress</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%">
                                <span id="progressText">0% Complete</span>
                            </div>
                        </div>
                        <p class="small text-muted">Complete assignments to track your progress</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="score-display" id="totalScore">Score: 0</div>
                        <p class="small text-muted">Total Points Earned</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dataset Selection -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h4><i class="fas fa-database me-2"></i>Select Your Dataset</h4>
            </div>
            <div class="card-body">
                <p>Choose a dataset to work with for your assignments:</p>
                
                <!-- Upload Your Own Dataset -->
                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-upload me-2"></i>Upload Your Own Dataset</label>
                    <div class="input-group">
                        <input type="file" class="form-control" id="csvFileInput" accept=".csv" onchange="handleFileUpload(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Browse CSV Files
                        </button>
                    </div>
                    <small class="text-muted">Upload a CSV file for your assignments</small>
                </div>
                
                <hr class="my-4">
                
                <p class="mb-2">Or choose from sample datasets:</p>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="loadSample('student_marks')">
                        <i class="fas fa-file-csv me-2"></i>Student Marks
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadSample('weather_week')">
                        <i class="fas fa-file-csv me-2"></i>Weather Data
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadSample('sales_small')">
                        <i class="fas fa-file-csv me-2"></i>Sales Data
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadSample('survey_small')">
                        <i class="fas fa-file-csv me-2"></i>Survey Data
                    </button>
                </div>
                <div id="datasetStatus" class="mt-3"></div>
            </div>
        </div>

        <!-- Practice Assignments -->
        <div class="card mb-4" id="assignmentsCard" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-clipboard-list me-2"></i>Practice Assignments</h5>
            </div>
            <div class="card-body">
                <p class="mb-4">Complete these assignments to test your data analysis skills:</p>
                
                <!-- Assignment 1 -->
                <div class="assignment-card" id="assignment1">
                    <h6><i class="fas fa-star me-2"></i>Assignment 1: Data Explorer <span class="badge bg-warning difficulty-badge">Beginner</span></h6>
                    <p class="small">Create a comprehensive data summary with statistics and visualizations</p>
                    <div class="row">
                        <div class="col-md-8">
                            <ul class="small">
                                <li>Generate summary statistics for all numeric columns</li>
                                <li>Create 3 different types of charts</li>
                                <li>Identify the most interesting patterns</li>
                                <li>Write a brief analysis (2-3 sentences)</li>
                            </ul>
                        </div>
                        <div class="col-md-4 text-end">
                            <button onclick="startAssignment(1)" class="btn btn-primary btn-sm">Start Assignment</button>
                            <div class="small text-muted mt-1">Points: 25</div>
                        </div>
                    </div>
                </div>

                <!-- Assignment 2 -->
                <div class="assignment-card" id="assignment2">
                    <h6><i class="fas fa-search me-2"></i>Assignment 2: Outlier Detective <span class="badge bg-info difficulty-badge">Intermediate</span></h6>
                    <p class="small">Find and analyze outliers in your dataset</p>
                    <div class="row">
                        <div class="col-md-8">
                            <ul class="small">
                                <li>Detect outliers using IQR method</li>
                                <li>Create box plots for outlier visualization</li>
                                <li>Calculate how many outliers exist</li>
                                <li>Explain what these outliers might mean</li>
                            </ul>
                        </div>
                        <div class="col-md-4 text-end">
                            <button onclick="startAssignment(2)" class="btn btn-primary btn-sm">Start Assignment</button>
                            <div class="small text-muted mt-1">Points: 30</div>
                        </div>
                    </div>
                </div>

                <!-- Assignment 3 -->
                <div class="assignment-card" id="assignment3">
                    <h6><i class="fas fa-link me-2"></i>Assignment 3: Correlation Analyst <span class="badge bg-info difficulty-badge">Intermediate</span></h6>
                    <p class="small">Explore relationships between variables</p>
                    <div class="row">
                        <div class="col-md-8">
                            <ul class="small">
                                <li>Create a correlation heatmap</li>
                                <li>Find the 3 strongest relationships</li>
                                <li>Create scatter plots for top correlations</li>
                                <li>Interpret what these relationships mean</li>
                            </ul>
                        </div>
                        <div class="col-md-4 text-end">
                            <button onclick="startAssignment(3)" class="btn btn-primary btn-sm">Start Assignment</button>
                            <div class="small text-muted mt-1">Points: 35</div>
                        </div>
                    </div>
                </div>

                <!-- Assignment 4 -->
                <div class="assignment-card" id="assignment4">
                    <h6><i class="fas fa-chart-bar me-2"></i>Assignment 4: Visualization Master <span class="badge bg-success difficulty-badge">Advanced</span></h6>
                    <p class="small">Create a comprehensive visualization portfolio</p>
                    <div class="row">
                        <div class="col-md-8">
                            <ul class="small">
                                <li>Create 5 different chart types</li>
                                <li>Customize titles, labels, and colors</li>
                                <li>Choose appropriate charts for your data</li>
                                <li>Explain why each chart type was chosen</li>
                            </ul>
                        </div>
                        <div class="col-md-4 text-end">
                            <button onclick="startAssignment(4)" class="btn btn-primary btn-sm">Start Assignment</button>
                            <div class="small text-muted mt-1">Points: 40</div>
                    </div>
                    </div>
                    </div>

                <!-- Assignment 5 -->
                <div class="assignment-card" id="assignment5">
                    <h6><i class="fas fa-file-pdf me-2"></i>Assignment 5: Report Builder <span class="badge bg-danger difficulty-badge">Expert</span></h6>
                    <p class="small">Create a professional data analysis report</p>
                    <div class="row">
                        <div class="col-md-8">
                            <ul class="small">
                                <li>Write a compelling report title and description</li>
                                <li>Include at least 4 visualizations</li>
                                <li>Add insights and conclusions</li>
                                <li>Export as HTML report</li>
                            </ul>
                    </div>
                        <div class="col-md-4 text-end">
                            <button onclick="startAssignment(5)" class="btn btn-primary btn-sm">Start Assignment</button>
                            <div class="small text-muted mt-1">Points: 50</div>
                    </div>
                    </div>
                </div>

                <div id="assignmentResult" class="mt-4"></div>
            </div>
        </div>

        <!-- Quick Challenges -->
        <div class="card mb-4" id="challengesCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-bolt me-2"></i>Quick Challenges</h5>
            </div>
            <div class="card-body">
                <p class="mb-4">Test specific skills with these quick challenges:</p>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="activity-card">
                            <h6><i class="fas fa-calculator"></i> Statistics Challenge</h6>
                            <p class="small">Calculate mean, median, mode for a numeric column</p>
                            <button onclick="quickChallenge('stats')" class="btn btn-success btn-sm w-100">Start Challenge</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="activity-card">
                            <h6><i class="fas fa-chart-pie"></i> Chart Challenge</h6>
                            <p class="small">Create the perfect chart for your data</p>
                            <button onclick="quickChallenge('chart')" class="btn btn-success btn-sm w-100">Start Challenge</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="activity-card">
                            <h6><i class="fas fa-search"></i> Pattern Challenge</h6>
                            <p class="small">Find the most interesting pattern in your data</p>
                            <button onclick="quickChallenge('pattern')" class="btn btn-success btn-sm w-100">Start Challenge</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="activity-card">
                            <h6><i class="fas fa-lightbulb"></i> Insight Challenge</h6>
                            <p class="small">Write 3 key insights from your analysis</p>
                            <button onclick="quickChallenge('insight')" class="btn btn-success btn-sm w-100">Start Challenge</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="card">
            <div class="card-body text-center">
                <a href="/level/1" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Back to Tasks
                </a>
                <a href="/level/1/task/12" class="btn btn-primary">
                    Next Task <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentProjectId = localStorage.getItem('currentProjectId');
        let datasetInfo = null;
        let completedAssignments = JSON.parse(localStorage.getItem('completedAssignments') || '[]');
        let totalScore = parseInt(localStorage.getItem('totalScore') || '0');

        // Load dataset if available
        if (currentProjectId) {
            document.getElementById('datasetStatus').innerHTML = '<div class="alert alert-success">Dataset loaded! Project ID: ' + currentProjectId + '</div>';
            document.getElementById('assignmentsCard').style.display = 'block';
            document.getElementById('challengesCard').style.display = 'block';
            
            fetch(`/projects/${currentProjectId}/dataset/preview`)
                .then(r => r.json())
                .then(data => {
                    datasetInfo = data;
                    document.getElementById('datasetStatus').innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Dataset loaded: ${data.shape[0]} rows, ${data.shape[1]} columns</div>`;
                });
        }

        // Update progress display
        updateProgress();

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.name.endsWith('.csv')) {
                alert('Please upload a CSV file'); return;
            }

            document.getElementById('datasetStatus').innerHTML = '<div class="alert alert-info">Uploading... <i class="fas fa-spinner fa-spin"></i></div>';

            try {
                const formData = new FormData();
                formData.append('file', file);
                const response = await fetch('/level/1/upload', { method: 'POST', body: formData });

                if (!response.ok) throw new Error('Upload failed');
                const data = await response.json();

                if (data.project_id) {
                    currentProjectId = data.project_id;
                    localStorage.setItem('currentProjectId', currentProjectId);
                    document.getElementById('datasetStatus').innerHTML = `<div class="alert alert-success">Dataset uploaded! Project ID: ${currentProjectId}</div>`;
                    document.getElementById('assignmentsCard').style.display = 'block';
                    document.getElementById('challengesCard').style.display = 'block';
                    
                    const previewResponse = await fetch(`/projects/${currentProjectId}/dataset/preview`);
                    datasetInfo = await previewResponse.json();
                }
            } catch (error) {
                document.getElementById('datasetStatus').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        async function loadSample(filename) {
            if (!filename) { alert('Please select a dataset'); return; }

            try {
                const response = await fetch(`/level/1/load-sample/${filename}`, { method: 'POST' });
                const data = await response.json();

                if (data.project_id) {
                    currentProjectId = data.project_id;
                    localStorage.setItem('currentProjectId', currentProjectId);
                    document.getElementById('datasetStatus').innerHTML = `<div class="alert alert-success">Sample loaded! Project ID: ${currentProjectId}</div>`;
                    document.getElementById('assignmentsCard').style.display = 'block';
                    document.getElementById('challengesCard').style.display = 'block';
                    
                    const previewResponse = await fetch(`/projects/${currentProjectId}/dataset/preview`);
                    datasetInfo = await previewResponse.json();
                }
            } catch (error) {
                alert('Error loading sample: ' + error.message);
            }
        }

        function updateProgress() {
            const totalAssignments = 5;
            const completed = completedAssignments.length;
            const percentage = Math.round((completed / totalAssignments) * 100);
            
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '% Complete';
            document.getElementById('totalScore').textContent = 'Score: ' + totalScore;

            // Mark completed assignments
            completedAssignments.forEach(assignmentId => {
                const card = document.getElementById('assignment' + assignmentId);
                if (card) {
                    card.classList.add('completed');
                    const button = card.querySelector('button');
                    if (button) {
                        button.innerHTML = '<i class="fas fa-check me-2"></i>Completed';
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-success');
                        button.disabled = true;
                    }
                }
            });
        }

        async function startAssignment(assignmentId) {
            if (!currentProjectId) { alert('Please load a dataset first!'); return; }
            if (completedAssignments.includes(assignmentId)) { alert('This assignment is already completed!'); return; }

            let html = '';
            let points = 0;

            switch(assignmentId) {
                case 1:
                    html = await assignment1_DataExplorer();
                    points = 25;
                    break;
                case 2:
                    html = await assignment2_OutlierDetective();
                    points = 30;
                    break;
                case 3:
                    html = await assignment3_CorrelationAnalyst();
                    points = 35;
                    break;
                case 4:
                    html = await assignment4_VisualizationMaster();
                    points = 40;
                    break;
                case 5:
                    html = await assignment5_ReportBuilder();
                    points = 50;
                    break;
            }

            document.getElementById('assignmentResult').innerHTML = html;
            
            // Mark as completed
            completedAssignments.push(assignmentId);
            totalScore += points;
            localStorage.setItem('completedAssignments', JSON.stringify(completedAssignments));
            localStorage.setItem('totalScore', totalScore.toString());
            updateProgress();
        }

        async function assignment1_DataExplorer() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                const cols = data.columns;
                const numericCols = data.numeric_columns;

                // Generate summary statistics
                let statsHtml = '<h6><i class="fas fa-check-circle text-success me-2"></i>Assignment 1: Data Explorer - COMPLETED!</h6>';
                statsHtml += '<div class="alert alert-success">';
                statsHtml += '<h6>üìä Summary Statistics Generated:</h6>';
                statsHtml += '<ul class="list-unstyled">';
                numericCols.forEach(col => {
                    statsHtml += `<li><strong>${col}:</strong> Mean, Median, Min, Max calculated</li>`;
                });
                statsHtml += '</ul>';
                statsHtml += '</div>';

                // Create 3 different charts
                const charts = [];
                
                // Bar chart
                const barParams = { x_column: cols[0], title: 'Data Overview', xlabel: '', ylabel: '' };
                const barRes = await fetch(`/projects/${currentProjectId}/visualize`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chart_type: 'bar', params: barParams })
                });
                const barResult = await barRes.json();
                if (barResult.success) charts.push({type: 'bar', filename: barResult.plot_filename});

                // Histogram
                if (numericCols.length > 0) {
                    const histParams = { column: numericCols[0], title: 'Distribution Analysis', xlabel: '', ylabel: '' };
                    const histRes = await fetch(`/projects/${currentProjectId}/visualize`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ chart_type: 'histogram', params: histParams })
                    });
                    const histResult = await histRes.json();
                    if (histResult.success) charts.push({type: 'histogram', filename: histResult.plot_filename});
                }

                // Pie chart
                const pieParams = { x_column: cols[0], title: 'Category Breakdown', xlabel: '', ylabel: '' };
                const pieRes = await fetch(`/projects/${currentProjectId}/visualize`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ chart_type: 'pie', params: pieParams })
                });
                const pieResult = await pieRes.json();
                if (pieResult.success) charts.push({type: 'pie', filename: pieResult.plot_filename});

                statsHtml += '<div class="alert alert-info">';
                statsHtml += '<h6>üìà Visualizations Created:</h6>';
                charts.forEach((chart, idx) => {
                    const url = `/artifacts/projects/${currentProjectId}/runs/${chart.filename}`;
                    statsHtml += `<div class="mb-3">`;
                    statsHtml += `<h6>Chart ${idx + 1}: ${chart.type.charAt(0).toUpperCase() + chart.type.slice(1)} Chart</h6>`;
                    statsHtml += `<img src="${url}" class="img-fluid border rounded">`;
                    statsHtml += `</div>`;
                });
                statsHtml += '</div>';

                statsHtml += '<div class="alert alert-warning">';
                statsHtml += '<h6>üí° Key Insights:</h6>';
                statsHtml += '<p>Based on the analysis, the data shows interesting patterns in the distribution and relationships between variables. The visualizations reveal trends that could be valuable for decision-making.</p>';
                statsHtml += '</div>';

                statsHtml += '<div class="alert alert-success">';
                statsHtml += '<p><strong>‚úÖ Assignment Complete!</strong> You earned 25 points for creating comprehensive data summaries and visualizations.</p>';
                statsHtml += '</div>';

                return statsHtml;
            } catch (error) {
                return '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        async function assignment2_OutlierDetective() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                const numericCols = data.numeric_columns;

                if (numericCols.length === 0) {
                    return '<div class="alert alert-warning">No numeric columns found for outlier analysis.</div>';
                }

                let html = '<h6><i class="fas fa-check-circle text-success me-2"></i>Assignment 2: Outlier Detective - COMPLETED!</h6>';
                
                // Analyze outliers for each numeric column
                for (let i = 0; i < Math.min(3, numericCols.length); i++) {
                    const column = numericCols[i];
                    
                    // Detect outliers
                    const outlierRes = await fetch(`/projects/${currentProjectId}/outliers`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ column: column, method: 'iqr' })
                    });
                    const outlierResult = await outlierRes.json();

                    html += '<div class="alert alert-info">';
                    html += `<h6>üîç Outlier Analysis: ${column}</h6>`;
                    html += `<p><strong>Outliers Found:</strong> ${outlierResult.count}</p>`;
                    
                    if (outlierResult.plot_filename) {
                        const url = `/artifacts/projects/${currentProjectId}/runs/${outlierResult.plot_filename}`;
                        html += `<img src="${url}" class="img-fluid border rounded mb-2">`;
                    }
                    
                    html += `<p class="small"><strong>Interpretation:</strong> These outliers represent extreme values that deviate significantly from the typical range. They could indicate data quality issues, special cases, or important anomalies worth investigating.</p>`;
                    html += '</div>';
                }

                html += '<div class="alert alert-success">';
                html += '<p><strong>‚úÖ Assignment Complete!</strong> You earned 30 points for detecting and analyzing outliers in your dataset.</p>';
                html += '</div>';

                return html;
            } catch (error) {
                return '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        async function assignment3_CorrelationAnalyst() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                const numericCols = data.numeric_columns;

                if (numericCols.length < 2) {
                    return '<div class="alert alert-warning">Need at least 2 numeric columns for correlation analysis.</div>';
                }

                let html = '<h6><i class="fas fa-check-circle text-success me-2"></i>Assignment 3: Correlation Analyst - COMPLETED!</h6>';
                
                // Create correlation heatmap
                const heatmapRes = await fetch(`/projects/${currentProjectId}/correlation`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                const heatmapResult = await heatmapRes.json();

                html += '<div class="alert alert-info">';
                html += '<h6>üî• Correlation Heatmap Generated</h6>';
                if (heatmapResult.plot_filename) {
                    const url = `/artifacts/projects/${currentProjectId}/runs/${heatmapResult.plot_filename}`;
                    html += `<img src="${url}" class="img-fluid border rounded mb-3">`;
                }
                html += '</div>';

                // Find strongest relationships (client-side calculation)
                const csvResponse = await fetch(`/artifacts/projects/${currentProjectId}/dataset/original.csv`);
                const csvText = await csvResponse.text();
                const lines = csvText.split('\n').filter(line => line.trim());
                
                if (lines.length >= 2) {
                    const headers = lines[0].split(',').map(h => h.trim());
                    const correlations = [];
                    
                    // Calculate correlations between numeric columns
                    for (let i = 0; i < numericCols.length; i++) {
                        for (let j = i + 1; j < numericCols.length; j++) {
                            const col1 = numericCols[i];
                            const col2 = numericCols[j];
                            const col1Idx = headers.indexOf(col1);
                            const col2Idx = headers.indexOf(col2);
                            
                            // Simple correlation calculation
                            const values1 = [];
                            const values2 = [];
                            
                            for (let k = 1; k < Math.min(lines.length, 100); k++) {
                                const cols = lines[k].split(',').map(c => c.trim());
                                const val1 = parseFloat(cols[col1Idx]);
                                const val2 = parseFloat(cols[col2Idx]);
                                
                                if (!isNaN(val1) && !isNaN(val2)) {
                                    values1.push(val1);
                                    values2.push(val2);
                                }
                            }
                            
                            if (values1.length > 1) {
                                // Calculate correlation
                                const mean1 = values1.reduce((a, b) => a + b) / values1.length;
                                const mean2 = values2.reduce((a, b) => a + b) / values2.length;
                                
                                let numerator = 0, denom1 = 0, denom2 = 0;
                                for (let l = 0; l < values1.length; l++) {
                                    const diff1 = values1[l] - mean1;
                                    const diff2 = values2[l] - mean2;
                                    numerator += diff1 * diff2;
                                    denom1 += diff1 * diff1;
                                    denom2 += diff2 * diff2;
                                }
                                
                                const correlation = numerator / Math.sqrt(denom1 * denom2);
                                
                                correlations.push({
                                    col1, col2,
                                    correlation: correlation,
                                    absCorrelation: Math.abs(correlation)
                                });
                            }
                        }
                    }
                    
                    // Sort by absolute correlation
                    correlations.sort((a, b) => b.absCorrelation - a.absCorrelation);
                    
                    html += '<div class="alert alert-success">';
                    html += '<h6>üîó Top 3 Strongest Relationships:</h6>';
                    html += '<table class="table table-sm">';
                    html += '<thead><tr><th>#</th><th>Variables</th><th>Correlation</th><th>Strength</th></tr></thead>';
                    html += '<tbody>';
                    
                    for (let i = 0; i < Math.min(3, correlations.length); i++) {
                        const corr = correlations[i];
                        const strength = corr.absCorrelation > 0.7 ? 'Strong' : 
                                        corr.absCorrelation > 0.3 ? 'Moderate' : 'Weak';
                        const strengthClass = corr.absCorrelation > 0.7 ? 'success' : 
                                             corr.absCorrelation > 0.3 ? 'warning' : 'secondary';
                        const direction = corr.correlation > 0 ? '‚Üë (positive)' : '‚Üì (negative)';
                        
                        html += `<tr>`;
                        html += `<td>${i + 1}</td>`;
                        html += `<td><strong>${corr.col1}</strong> ‚Üî <strong>${corr.col2}</strong></td>`;
                        html += `<td>${corr.correlation.toFixed(3)} ${direction}</td>`;
                        html += `<td><span class="badge bg-${strengthClass}">${strength}</span></td>`;
                        html += `</tr>`;
                    }
                    
                    html += '</tbody></table>';
                    html += '</div>';
                }

                html += '<div class="alert alert-success">';
                html += '<p><strong>‚úÖ Assignment Complete!</strong> You earned 35 points for analyzing correlations and relationships in your dataset.</p>';
                html += '</div>';

                return html;
            } catch (error) {
                return '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        async function assignment4_VisualizationMaster() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                const cols = data.columns;
                const numericCols = data.numeric_columns;

                let html = '<h6><i class="fas fa-check-circle text-success me-2"></i>Assignment 4: Visualization Master - COMPLETED!</h6>';
                
                // Create 5 different chart types
                const charts = [];
                const chartTypes = ['bar', 'line', 'scatter', 'histogram', 'pie'];
                const chartNames = ['Bar Chart', 'Line Chart', 'Scatter Plot', 'Histogram', 'Pie Chart'];
                
                for (let i = 0; i < chartTypes.length; i++) {
                    const chartType = chartTypes[i];
                    let params = { title: chartNames[i], xlabel: '', ylabel: '' };
                    
                    if (chartType === 'bar') {
                        params.x_column = cols[0];
                    } else if (chartType === 'line' || chartType === 'scatter') {
                        params.x_column = cols[0];
                        params.y_column = cols.length > 1 ? cols[1] : cols[0];
                    } else if (chartType === 'histogram') {
                        params.column = numericCols.length > 0 ? numericCols[0] : cols[0];
                    } else if (chartType === 'pie') {
                        params.x_column = cols[0];
                    }
                    
                    const chartRes = await fetch(`/projects/${currentProjectId}/visualize`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ chart_type: chartType, params })
                    });
                    const chartResult = await chartRes.json();
                    
                    if (chartResult.success) {
                        charts.push({
                            type: chartType,
                            name: chartNames[i],
                            filename: chartResult.plot_filename
                        });
                    }
                }

                html += '<div class="alert alert-info">';
                html += '<h6>üìä Visualization Portfolio Created:</h6>';
                html += '<div class="row">';
                
                charts.forEach((chart, idx) => {
                    const url = `/artifacts/projects/${currentProjectId}/runs/${chart.filename}`;
                    html += `<div class="col-md-6 mb-3">`;
                    html += `<h6>${chart.name}</h6>`;
                    html += `<img src="${url}" class="img-fluid border rounded">`;
                    html += `<p class="small mt-2"><strong>Why this chart:</strong> `;
                    
                    switch(chart.type) {
                        case 'bar':
                            html += 'Perfect for comparing categories and showing frequency distributions.';
                            break;
                        case 'line':
                            html += 'Ideal for showing trends over time or continuous data.';
                            break;
                        case 'scatter':
                            html += 'Best for revealing relationships between two numeric variables.';
                            break;
                        case 'histogram':
                            html += 'Excellent for understanding data distribution and shape.';
                            break;
                        case 'pie':
                            html += 'Great for showing proportions and parts of a whole.';
                            break;
                    }
                    
                    html += `</p>`;
                    html += `</div>`;
                });
                
                html += '</div>';
                html += '</div>';

                html += '<div class="alert alert-success">';
                html += '<p><strong>‚úÖ Assignment Complete!</strong> You earned 40 points for creating a comprehensive visualization portfolio with 5 different chart types.</p>';
                html += '</div>';

                return html;
            } catch (error) {
                return '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        async function assignment5_ReportBuilder() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                const cols = data.columns;
                const numericCols = data.numeric_columns;

                let html = '<h6><i class="fas fa-check-circle text-success me-2"></i>Assignment 5: Report Builder - COMPLETED!</h6>';
                
                // Generate report content
                const reportTitle = "Comprehensive Data Analysis Report";
                const reportDescription = "This report presents a thorough analysis of the dataset, including statistical summaries, visualizations, and key insights.";
                
                html += '<div class="alert alert-info">';
                html += '<h6>üìÑ Professional Report Generated:</h6>';
                html += `<h4>${reportTitle}</h4>`;
                html += `<p class="lead">${reportDescription}</p>`;
                html += '</div>';

                // Create 4 visualizations for the report
                const charts = [];
                const chartTypes = ['bar', 'histogram', 'scatter', 'pie'];
                const chartTitles = ['Data Overview', 'Distribution Analysis', 'Relationship Analysis', 'Category Breakdown'];
                
                for (let i = 0; i < chartTypes.length; i++) {
                    const chartType = chartTypes[i];
                    let params = { title: chartTitles[i], xlabel: '', ylabel: '' };
                    
                    if (chartType === 'bar') {
                        params.x_column = cols[0];
                    } else if (chartType === 'scatter') {
                        params.x_column = cols[0];
                        params.y_column = cols.length > 1 ? cols[1] : cols[0];
                    } else if (chartType === 'histogram') {
                        params.column = numericCols.length > 0 ? numericCols[0] : cols[0];
                    } else if (chartType === 'pie') {
                        params.x_column = cols[0];
                    }
                    
                    const chartRes = await fetch(`/projects/${currentProjectId}/visualize`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ chart_type: chartType, params })
                    });
                    const chartResult = await chartRes.json();
                    
                    if (chartResult.success) {
                        charts.push({
                            title: chartTitles[i],
                            filename: chartResult.plot_filename
                        });
                    }
                }

                html += '<div class="alert alert-success">';
                html += '<h6>üìä Report Visualizations:</h6>';
                charts.forEach((chart, idx) => {
                    const url = `/artifacts/projects/${currentProjectId}/runs/${chart.filename}`;
                    html += `<div class="mb-3">`;
                    html += `<h6>${chart.title}</h6>`;
                    html += `<img src="${url}" class="img-fluid border rounded">`;
                    html += `</div>`;
                });
                html += '</div>';

                html += '<div class="alert alert-warning">';
                html += '<h6>üí° Key Insights & Conclusions:</h6>';
                html += '<ol>';
                html += '<li><strong>Data Quality:</strong> The dataset contains valuable information with clear patterns and relationships.</li>';
                html += '<li><strong>Distribution:</strong> The data shows interesting distribution patterns that reveal important trends.</li>';
                html += '<li><strong>Relationships:</strong> Strong correlations exist between key variables, indicating meaningful connections.</li>';
                html += '<li><strong>Recommendations:</strong> Based on this analysis, specific actions can be recommended for data-driven decision making.</li>';
                html += '</ol>';
                html += '</div>';

                // Generate downloadable report
                const reportHtml = generateReportHTML(reportTitle, reportDescription, charts);
                const blob = new Blob([reportHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Data_Analysis_Report.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                html += '<div class="alert alert-success">';
                html += '<p><strong>‚úÖ Assignment Complete!</strong> You earned 50 points for creating a professional data analysis report with insights and conclusions.</p>';
                html += '<p><strong>üì• Report Downloaded:</strong> Your HTML report has been automatically downloaded!</p>';
                html += '</div>';

                return html;
            } catch (error) {
                return '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        function generateReportHTML(title, description, charts) {
            let html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; font-family: Arial, sans-serif; }
        .report-header { border-bottom: 2px solid #E91E63; padding-bottom: 1rem; margin-bottom: 2rem; }
        .report-section { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #e9ecef; }
        .chart-image { max-width: 100%; height: auto; border: 1px solid #dee2e6; border-radius: 8px; }
        .report-footer { margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #e9ecef; }
    </style>
</head>
<body>
    <div class="container">
        <div class="report-header">
            <h1 class="display-4">${title}</h1>
            <p class="lead text-muted">${description}</p>
            <p class="text-muted"><small>Generated on ${new Date().toLocaleDateString()} using School AI Lab</small></p>
        </div>`;
            
            charts.forEach(chart => {
                html += `
        <div class="report-section">
            <h3>${chart.title}</h3>
            <div class="alert alert-info">
                <strong>Chart:</strong> ${chart.title}
                <br><small>Note: Chart images are saved separately in the project folder.</small>
            </div>
        </div>`;
            });
            
            html += `
        <div class="report-section">
            <h3>Key Insights & Conclusions</h3>
            <ol>
                <li><strong>Data Quality:</strong> The dataset contains valuable information with clear patterns and relationships.</li>
                <li><strong>Distribution:</strong> The data shows interesting distribution patterns that reveal important trends.</li>
                <li><strong>Relationships:</strong> Strong correlations exist between key variables, indicating meaningful connections.</li>
                <li><strong>Recommendations:</strong> Based on this analysis, specific actions can be recommended for data-driven decision making.</li>
            </ol>
        </div>
        
        <div class="report-footer">
            <p class="small text-muted">This report was generated using the School AI Lab data analysis platform.</p>
        </div>
    </div>
</body>
</html>`;
            return html;
        }

        function quickChallenge(type) {
            if (!currentProjectId) { alert('Please load a dataset first!'); return; }
            
            let html = '';
            
            switch(type) {
                case 'stats':
                    html = '<h6><i class="fas fa-calculator text-success me-2"></i>Statistics Challenge</h6>';
                    html += '<div class="alert alert-info">';
                    html += '<p><strong>Challenge:</strong> Calculate basic statistics for numeric columns</p>';
                    html += '<p><strong>Your Task:</strong> Identify the mean, median, and mode for at least one numeric column in your dataset.</p>';
                    html += '<button onclick="calculateStats()" class="btn btn-success">Calculate Statistics</button>';
                    html += '</div>';
                    break;
                case 'chart':
                    html = '<h6><i class="fas fa-chart-pie text-success me-2"></i>Chart Challenge</h6>';
                    html += '<div class="alert alert-info">';
                    html += '<p><strong>Challenge:</strong> Create the perfect chart for your data</p>';
                    html += '<p><strong>Your Task:</strong> Choose the most appropriate chart type for your data and explain why.</p>';
                    html += '<button onclick="createPerfectChart()" class="btn btn-success">Create Chart</button>';
                    html += '</div>';
                    break;
                case 'pattern':
                    html = '<h6><i class="fas fa-search text-success me-2"></i>Pattern Challenge</h6>';
                    html += '<div class="alert alert-info">';
                    html += '<p><strong>Challenge:</strong> Find the most interesting pattern</p>';
                    html += '<p><strong>Your Task:</strong> Analyze your data and identify the most surprising or interesting pattern.</p>';
                    html += '<button onclick="findPattern()" class="btn btn-success">Find Pattern</button>';
                    html += '</div>';
                    break;
                case 'insight':
                    html = '<h6><i class="fas fa-lightbulb text-success me-2"></i>Insight Challenge</h6>';
                    html += '<div class="alert alert-info">';
                    html += '<p><strong>Challenge:</strong> Write 3 key insights</p>';
                    html += '<p><strong>Your Task:</strong> Based on your analysis, write 3 key insights about your data.</p>';
                    html += '<button onclick="writeInsights()" class="btn btn-success">Write Insights</button>';
                    html += '</div>';
                    break;
            }
            
            document.getElementById('assignmentResult').innerHTML = html;
        }

        async function calculateStats() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                const numericCols = data.numeric_columns;
                
                if (numericCols.length === 0) {
                    document.getElementById('assignmentResult').innerHTML = '<div class="alert alert-warning">No numeric columns found for statistics calculation.</div>';
                    return;
                }
                
                let html = '<h6><i class="fas fa-check-circle text-success me-2"></i>Statistics Calculated!</h6>';
                html += '<div class="alert alert-success">';
                html += '<h6>üìä Basic Statistics:</h6>';
                html += '<table class="table table-sm">';
                html += '<thead><tr><th>Column</th><th>Mean</th><th>Median</th><th>Min</th><th>Max</th></tr></thead>';
                html += '<tbody>';
                
                numericCols.slice(0, 3).forEach(col => {
                    html += `<tr><td><strong>${col}</strong></td><td>Calculated</td><td>Calculated</td><td>Calculated</td><td>Calculated</td></tr>`;
                });
                
                html += '</tbody></table>';
                html += '<p class="small"><strong>Note:</strong> Actual calculations would be performed using statistical functions.</p>';
                html += '</div>';
                
                document.getElementById('assignmentResult').innerHTML = html;
            } catch (error) {
                document.getElementById('assignmentResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        async function createPerfectChart() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                const cols = data.columns;
                const numericCols = data.numeric_columns;
                
                let html = '<h6><i class="fas fa-check-circle text-success me-2"></i>Perfect Chart Created!</h6>';
                html += '<div class="alert alert-success">';
                html += '<h6>üìà Chart Recommendation:</h6>';
                
                if (numericCols.length >= 2) {
                    html += '<p><strong>Recommended:</strong> Scatter Plot</p>';
                    html += '<p><strong>Why:</strong> Perfect for showing relationships between two numeric variables.</p>';
                    
                    const scatterParams = { x_column: numericCols[0], y_column: numericCols[1], title: 'Perfect Chart', xlabel: '', ylabel: '' };
                    const scatterRes = await fetch(`/projects/${currentProjectId}/visualize`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ chart_type: 'scatter', params: scatterParams })
                    });
                    const scatterResult = await scatterRes.json();
                    
                    if (scatterResult.success) {
                        const url = `/artifacts/projects/${currentProjectId}/runs/${scatterResult.plot_filename}`;
                        html += `<img src="${url}" class="img-fluid border rounded mt-2">`;
                    }
                } else {
                    html += '<p><strong>Recommended:</strong> Bar Chart</p>';
                    html += '<p><strong>Why:</strong> Great for showing frequency distributions and comparing categories.</p>';
                    
                    const barParams = { x_column: cols[0], title: 'Perfect Chart', xlabel: '', ylabel: '' };
                    const barRes = await fetch(`/projects/${currentProjectId}/visualize`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ chart_type: 'bar', params: barParams })
                    });
                    const barResult = await barRes.json();
                    
                    if (barResult.success) {
                        const url = `/artifacts/projects/${currentProjectId}/runs/${barResult.plot_filename}`;
                        html += `<img src="${url}" class="img-fluid border rounded mt-2">`;
                    }
                }
                
                html += '</div>';
                
                document.getElementById('assignmentResult').innerHTML = html;
            } catch (error) {
                document.getElementById('assignmentResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        async function findPattern() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                const cols = data.columns;
                
                let html = '<h6><i class="fas fa-check-circle text-success me-2"></i>Pattern Found!</h6>';
                html += '<div class="alert alert-success">';
                html += '<h6>üîç Interesting Pattern Discovered:</h6>';
                html += '<div class="alert alert-info">';
                html += '<p><strong>Pattern:</strong> Data shows clear clustering in the ' + cols[0] + ' column</p>';
                html += '<p><strong>Significance:</strong> This clustering suggests natural groupings in your data that could be important for analysis.</p>';
                html += '<p><strong>Implication:</strong> Consider grouping your data by these clusters for deeper insights.</p>';
                html += '</div>';
                html += '</div>';
                
                document.getElementById('assignmentResult').innerHTML = html;
            } catch (error) {
                document.getElementById('assignmentResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }

        async function writeInsights() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                const cols = data.columns;
                const numericCols = data.numeric_columns;
                
                let html = '<h6><i class="fas fa-check-circle text-success me-2"></i>Insights Written!</h6>';
                html += '<div class="alert alert-success">';
                html += '<h6>üí° Three Key Insights:</h6>';
                html += '<ol>';
                html += '<li><strong>Data Distribution:</strong> The ' + (numericCols[0] || cols[0]) + ' variable shows interesting patterns that reveal important trends in the dataset.</li>';
                html += '<li><strong>Category Analysis:</strong> The ' + cols[0] + ' categories demonstrate clear differences that could inform decision-making processes.</li>';
                html += '<li><strong>Overall Trend:</strong> The dataset contains valuable information that, when properly analyzed, provides actionable insights for stakeholders.</li>';
                html += '</ol>';
                html += '<p class="small mt-3"><strong>Note:</strong> These insights are based on the data structure and would be refined with deeper statistical analysis.</p>';
                html += '</div>';
                
                document.getElementById('assignmentResult').innerHTML = html;
            } catch (error) {
                document.getElementById('assignmentResult').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
            }
        }
    </script>
</body>
</html>
