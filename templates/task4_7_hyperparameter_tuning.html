<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 4.7: Hyperparameter Tuning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .task-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; }
        .learning-objective { background: #f8f9fa; padding: 1rem; border-left: 4px solid #764ba2; }
    </style>
</head>
<body>
    <div class="task-header">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-tune me-3"></i>Task 4.7: Hyperparameter Tuning</h1>
                <p class="lead mb-0">Optimize model performance by tuning hyperparameters</p>
            </div>
            <a href="/level/4" class="btn btn-light">← Back to Level 4</a>
        </div>
    </div>

    <div class="container py-4">
        <div class="learning-objective mb-4">
            <h4><i class="fas fa-bullseye me-2"></i>Learning Objective</h4>
            <p class="mb-0">Learn grid search and random search to find optimal hyperparameters: C (regularization), n-gram range, max_features for vectorizer, and model-specific parameters.</p>
        </div>

        <!-- Activity 1: Define Search Space -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-sliders-h me-2"></i>Activity 1: Define Hyperparameter Search Space</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Vectorizer: Max Features</label>
                        <input type="text" id="maxFeatRange" class="form-control" placeholder="1000,2000,5000,10000" value="1000,5000,10000">
                        <small class="text-muted">Comma-separated values</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">N-gram Range (min,max)</label>
                        <input type="text" id="ngramRange" class="form-control" placeholder="(1,1),(1,2),(2,2)" value="(1,1),(1,2)">
                        <small class="text-muted">Format: (min,max) pairs</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Model C (LogReg/SVM)</label>
                        <input type="text" id="cRange" class="form-control" placeholder="0.1,1,10,100" value="0.1,1,10,100">
                        <small class="text-muted">Regularization strength</small>
                    </div>
                </div>
                <div class="mt-3">
                    <label class="form-label">Search Method</label>
                    <select id="searchMethod" class="form-select">
                        <option value="grid">Grid Search (exhaustive)</option>
                        <option value="random">Random Search (sampling)</option>
                    </select>
                </div>
                <div class="mt-3">
                    <label class="form-label">Number of Trials (for Random Search)</label>
                    <input type="number" id="nTrials" class="form-control" value="20" min="5" max="100">
                </div>
            </div>
        </div>

        <!-- Activity 2: Run Tuning -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-play me-2"></i>Activity 2: Run Hyperparameter Tuning</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Select your dataset columns and run the tuning process.</p>
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Text Column</label>
                        <select id="textCol" class="form-select"></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Label Column</label>
                        <select id="labelCol" class="form-select"></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Model Type</label>
                        <select id="modelType" class="form-select">
                            <option value="logreg">Logistic Regression</option>
                            <option value="nb">Multinomial Naive Bayes</option>
                            <option value="linear_svm">Linear SVM</option>
                        </select>
                    </div>
                </div>
                <div class="text-end mt-3">
                    <button class="btn btn-success btn-lg" onclick="runTuning()"><i class="fas fa-rocket me-2"></i>Start Tuning</button>
                </div>
                <div id="tuningProgress" class="mt-3" style="display:none">
                    <div class="progress mb-2">
                        <div id="tuningBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%"></div>
                    </div>
                    <div id="tuningStatus" class="text-muted"></div>
                </div>
                <div id="tuningResults" class="mt-3" style="display:none"></div>
            </div>
        </div>

        <!-- Activity 3: Analyze Results -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-chart-line me-2"></i>Activity 3: Analyze Results</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Compare different hyperparameter combinations and their impact on model performance.</p>
                <div id="analysisResults" style="display:none"></div>
            </div>
        </div>

        <!-- Activity 4: Apply Best Parameters -->
        <div class="card mb-4">
            <div class="card-header bg-warning">
                <h5><i class="fas fa-check-circle me-2"></i>Activity 4: Apply Best Hyperparameters</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Once you identify the best parameters, apply them to train a final model.</p>
                <div id="applyBest" style="display:none">
                    <div class="alert alert-success">
                        <strong>Best Parameters Found:</strong>
                        <div id="bestParams"></div>
                    </div>
                    <button class="btn btn-warning" onclick="applyBestParams()"><i class="fas fa-magic me-2"></i>Train Final Model with Best Params</button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="card">
            <div class="card-body text-center">
                <a href="/level/4" class="btn btn-outline-secondary me-2">Back to Level 4</a>
                <a href="/level/4/task/6" class="btn btn-outline-primary me-2">← Previous: Evaluation</a>
                <a href="/level/4/task/8" class="btn btn-primary">Next: Model Comparison <i class="fas fa-arrow-right ms-2"></i></a>
            </div>
        </div>
    </div>

    <script>
        let currentProjectId = null;
        let bestParams = null;

        window.addEventListener('DOMContentLoaded', async () => {
            currentProjectId = localStorage.getItem('level3_project_id') || localStorage.getItem('level4_project_id');
            if (!currentProjectId) { alert('No project found'); return; }
            await populateColumns();
        });

        async function populateColumns() {
            try {
                const res = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await res.json();
                const cols = data.columns || [];
                ['textCol', 'labelCol'].forEach(id => {
                    const sel = document.getElementById(id);
                    sel.innerHTML = '<option value="">Select...</option>' + cols.map(c => `<option value="${c}">${c}</option>`).join('');
                });
            } catch(e) {}
        }

        async function runTuning() {
            const textCol = document.getElementById('textCol').value;
            const labelCol = document.getElementById('labelCol').value;
            const modelType = document.getElementById('modelType').value;
            const maxFeatRange = document.getElementById('maxFeatRange').value.split(',').map(x => parseInt(x.trim())).filter(x => !isNaN(x));
            const ngramRangeStr = document.getElementById('ngramRange').value;
            const cRange = document.getElementById('cRange').value.split(',').map(x => parseFloat(x.trim())).filter(x => !isNaN(x));
            const searchMethod = document.getElementById('searchMethod').value;
            const nTrials = parseInt(document.getElementById('nTrials').value);

            if (!textCol || !labelCol) { alert('Select columns'); return; }

            document.getElementById('tuningProgress').style.display = 'block';
            document.getElementById('tuningResults').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'none';
            document.getElementById('applyBest').style.display = 'none';

            // Simulate tuning process (in real implementation, this would call backend)
            const combinations = searchMethod === 'grid' ? 
                maxFeatRange.length * (ngramRangeStr.includes('(1,1)') ? 1 : 2) * cRange.length :
                Math.min(nTrials, maxFeatRange.length * 4 * cRange.length);
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 100 / combinations;
                document.getElementById('tuningBar').style.width = Math.min(progress, 100) + '%';
                document.getElementById('tuningStatus').textContent = `Testing combination ${Math.floor(progress / (100/combinations))} of ${combinations}...`;
                if (progress >= 100) {
                    clearInterval(interval);
                    showTuningResults(maxFeatRange, cRange, modelType);
                }
            }, 500);
        }

        function showTuningResults(maxFeatRange, cRange, modelType) {
            // Simulated results (in real implementation, backend would return actual results)
            const results = [];
            maxFeatRange.forEach(mf => {
                cRange.forEach(c => {
                    const acc = 0.75 + Math.random() * 0.2; // Simulated accuracy
                    results.push({
                        max_features: mf,
                        c: c,
                        ngram: '(1,2)',
                        accuracy: acc.toFixed(3),
                        precision: (acc + 0.02).toFixed(3),
                        recall: (acc - 0.01).toFixed(3),
                        f1: acc.toFixed(3)
                    });
                });
            });

            results.sort((a, b) => parseFloat(b.accuracy) - parseFloat(a.accuracy));
            bestParams = results[0];

            let html = '<div class="alert alert-success"><h6>Top 5 Configurations:</h6><table class="table table-sm"><thead><tr><th>Rank</th><th>Max Features</th><th>C</th><th>N-gram</th><th>Accuracy</th><th>F1</th></tr></thead><tbody>';
            results.slice(0, 5).forEach((r, i) => {
                html += `<tr ${i === 0 ? 'class="table-success"' : ''}><td>${i+1}</td><td>${r.max_features}</td><td>${r.c}</td><td>${r.ngram}</td><td>${r.accuracy}</td><td>${r.f1}</td></tr>`;
            });
            html += '</tbody></table></div>';

            document.getElementById('tuningResults').innerHTML = html;
            document.getElementById('tuningResults').style.display = 'block';

            // Show best params
            document.getElementById('bestParams').innerHTML = `
                <ul>
                    <li><strong>Max Features:</strong> ${bestParams.max_features}</li>
                    <li><strong>C:</strong> ${bestParams.c}</li>
                    <li><strong>N-gram Range:</strong> ${bestParams.ngram}</li>
                    <li><strong>Best Accuracy:</strong> ${bestParams.accuracy}</li>
                </ul>
            `;
            document.getElementById('applyBest').style.display = 'block';

            // Analysis
            const analysisHtml = '<div class="alert alert-info"><h6>Analysis Insights:</h6><ul><li>Higher max_features generally improves accuracy but increases training time</li><li>C parameter controls regularization: lower C = more regularization (prevents overfitting)</li><li>N-grams (1,2) capture more context than (1,1) but increase feature space</li><li>Best combination balances accuracy and model complexity</li></ul></div>';
            document.getElementById('analysisResults').innerHTML = analysisHtml;
            document.getElementById('analysisResults').style.display = 'block';
        }

        async function applyBestParams() {
            if (!bestParams) { alert('Run tuning first'); return; }
            alert('Best parameters saved! Go to Task 4.4 (Classification) and use these parameters when training your model.');
            // In real implementation, save to project metadata
        }
    </script>
</body>
</html>

