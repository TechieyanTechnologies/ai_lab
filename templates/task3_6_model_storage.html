<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 3.6: Model Storage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .task-header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem 0; }
        .learning-objective { background: #f8f9fa; padding: 1rem; border-left: 4px solid #f5576c; }
        .model-card { border: 2px solid #dee2e6; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; transition: all 0.3s; }
        .model-card:hover { border-color: #f5576c; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .model-card.stored { border-color: #28a745; background: #f8fff9; }
        .metric-badge { font-size: 0.9rem; padding: 0.25rem 0.75rem; }
        .storage-form { background: #f8f9fa; padding: 1.5rem; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="task-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-box me-3"></i>Task 3.6: Model Storage</h1>
                    <p class="lead mb-0">Organize, version, and manage your trained YOLOv5 models</p>
                </div>
                <a href="/level/3" class="btn btn-light">‚Üê Back to Level 3</a>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Learning Objective -->
        <div class="learning-objective mb-4">
            <h4><i class="fas fa-bullseye me-2"></i>Learning Objective</h4>
            <p class="mb-0">Learn best practices for model versioning, storage, and metadata management. Understand how to organize trained models for production use.</p>
        </div>

        <!-- Project Check -->
        <div class="card mb-4" id="noProjectCard" style="display: none;">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                <h5 class="mt-3">No Project Found</h5>
                <p>Please complete Task 3.1 to create a project first</p>
                <a href="/level/3/task/1" class="btn btn-primary">
                    <i class="fas fa-arrow-left me-2"></i>Go to Task 3.1: Project Setup
                </a>
            </div>
        </div>

        <!-- Storage Interface -->
        <div id="storageInterface" style="display: none;">
            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 id="trainedCount">0</h3>
                            <p class="text-muted mb-0">Trained Models</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 id="storedCount">0</h3>
                            <p class="text-muted mb-0">Stored Models</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 id="totalSize">0 MB</h3>
                            <p class="text-muted mb-0">Storage Used</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Store New Model Section -->
            <div class="card mb-4" id="storeNewModelCard" style="display: none;">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-plus-circle me-2"></i>Store New Model</h5>
                    <p class="mb-0 small">Save a trained model from Task 3.5 to your model library</p>
                </div>
                <div class="card-body">
                    <div id="trainedModelsList"></div>
                </div>
            </div>

            <!-- Stored Models Section -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-database me-2"></i>Stored Models Library</h5>
                    <p class="mb-0 small">View and manage your stored models</p>
                </div>
                <div class="card-body">
                    <div id="storedModelsList">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-box-open" style="font-size: 3rem;"></i>
                            <p class="mt-3">No stored models yet. Train and store your first model to get started!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Storage Best Practices -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-lightbulb me-2"></i>Model Storage Best Practices</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li><strong>Versioning:</strong> Use semantic versioning (e.g., 1.0.0, 1.1.0) to track model improvements</li>
                        <li><strong>Naming:</strong> Use descriptive names that indicate the model's purpose or training date</li>
                        <li><strong>Metadata:</strong> Always include descriptions and metrics to help identify the best model</li>
                        <li><strong>Organization:</strong> Keep multiple versions to compare performance and rollback if needed</li>
                        <li><strong>Documentation:</strong> Document training parameters, dataset info, and expected performance</li>
                        <li><strong>Storage:</strong> Models are saved in <code>artifacts/projects/{project_id}/models/</code></li>
                    </ul>
                </div>
            </div>

            <!-- Navigation -->
            <div class="card mt-4">
                <div class="card-body text-center">
                    <a href="/level/3/task/5" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>Previous Task
                    </a>
                    <a href="/level/3" class="btn btn-outline-secondary me-2">
                        Back to Level 3
                    </a>
                    <a href="/level/3/task/7" class="btn btn-primary">
                        Next Task <i class="fas fa-arrow-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Model Modal -->
    <div class="modal fade" id="storeModelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-save me-2"></i>Store Model</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="storeModelForm">
                        <input type="hidden" id="storeRunId">
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-tag me-2"></i>Model Name</label>
                            <input type="text" class="form-control" id="storeModelName" required 
                                   placeholder="e.g., object_detector_v1">
                            <small class="text-muted">.pt extension will be added automatically</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-code-branch me-2"></i>Version</label>
                            <input type="text" class="form-control" id="storeVersion" value="1.0" 
                                   placeholder="e.g., 1.0.0">
                            <small class="text-muted">Use semantic versioning (e.g., 1.0.0, 1.1.0)</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-align-left me-2"></i>Description</label>
                            <textarea class="form-control" id="storeDescription" rows="3" 
                                      placeholder="Describe this model, its purpose, training dataset, etc."></textarea>
                        </div>
                        <div id="storeModelMetrics" class="alert alert-info">
                            <!-- Metrics will be shown here -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmStoreModel()">
                        <i class="fas fa-save me-2"></i>Store Model
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Model Modal -->
    <div class="modal fade" id="editModelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Model Metadata</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editModelForm">
                        <input type="hidden" id="editModelName">
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-code-branch me-2"></i>Version</label>
                            <input type="text" class="form-control" id="editVersion" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-align-left me-2"></i>Description</label>
                            <textarea class="form-control" id="editDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="confirmUpdateModel()">
                        <i class="fas fa-save me-2"></i>Update Metadata
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentProjectId = null;
        let modelsData = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            currentProjectId = localStorage.getItem('level3_project_id');
            
            if (!currentProjectId) {
                document.getElementById('noProjectCard').style.display = 'block';
                return;
            }

            document.getElementById('storageInterface').style.display = 'block';
            await loadModels();
        });

        async function loadModels() {
            try {
                const response = await fetch(`/level/3/projects/${currentProjectId}/models`);
                const data = await response.json();
                modelsData = data;
                
                // Update statistics
                document.getElementById('trainedCount').textContent = data.trained_count || 0;
                document.getElementById('storedCount').textContent = data.stored_count || 0;
                
                // Calculate total storage
                let totalSize = 0;
                if (data.stored_models) {
                    data.stored_models.forEach(model => {
                        totalSize += model.size_mb || 0;
                    });
                }
                document.getElementById('totalSize').textContent = totalSize.toFixed(2) + ' MB';
                
                // Display trained models (available to store)
                displayTrainedModels(data.trained_models || []);
                
                // Display stored models
                displayStoredModels(data.stored_models || []);
                
            } catch (error) {
                console.error('Error loading models:', error);
                alert('Error loading models: ' + error.message);
            }
        }

        function displayTrainedModels(models) {
            const container = document.getElementById('trainedModelsList');
            
            if (!models || models.length === 0) {
                document.getElementById('storeNewModelCard').style.display = 'none';
                return;
            }
            
            document.getElementById('storeNewModelCard').style.display = 'block';
            container.innerHTML = '';
            
            models.forEach(model => {
                const card = document.createElement('div');
                card.className = 'model-card';
                
                let metricsHtml = '';
                if (model.metrics) {
                    if (model.metrics.mAP50) {
                        metricsHtml += `<span class="badge bg-success metric-badge">mAP50: ${(model.metrics.mAP50 * 100).toFixed(1)}%</span> `;
                    }
                    if (model.metrics['mAP50-95']) {
                        metricsHtml += `<span class="badge bg-info metric-badge">mAP50-95: ${(model.metrics['mAP50-95'] * 100).toFixed(1)}%</span>`;
                    }
                }
                
                card.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6><i class="fas fa-cube me-2"></i>Training Run: <code>${model.run_id}</code></h6>
                            <p class="mb-2">
                                <span class="badge bg-primary">Epochs: ${model.epochs}</span>
                                ${model.loss ? `<span class="badge bg-danger ms-2">Loss: ${model.loss.toFixed(4)}</span>` : ''}
                            </p>
                            ${metricsHtml ? `<p class="mb-2">${metricsHtml}</p>` : ''}
                            <p class="text-muted small mb-0">
                                <i class="fas fa-calendar me-1"></i>Created: ${new Date(model.created_at).toLocaleString()}
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="openStoreModal('${model.run_id}')">
                                <i class="fas fa-save me-2"></i>Store Model
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function displayStoredModels(models) {
            const container = document.getElementById('storedModelsList');
            
            if (!models || models.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-box-open" style="font-size: 3rem;"></i>
                        <p class="mt-3">No stored models yet. Store a trained model above to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            models.forEach(model => {
                const card = document.createElement('div');
                card.className = 'model-card stored';
                
                let metricsHtml = '';
                if (model.metrics) {
                    if (model.metrics.mAP50) {
                        metricsHtml += `<span class="badge bg-success metric-badge">mAP50: ${(model.metrics.mAP50 * 100).toFixed(1)}%</span> `;
                    }
                    if (model.metrics['mAP50-95']) {
                        metricsHtml += `<span class="badge bg-info metric-badge">mAP50-95: ${(model.metrics['mAP50-95'] * 100).toFixed(1)}%</span>`;
                    }
                }
                
                card.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-box me-2"></i>${model.name}</h5>
                            <p class="mb-2">
                                <span class="badge bg-secondary">Version: ${model.version}</span>
                                <span class="badge bg-success ms-2">Size: ${model.size_mb} MB</span>
                            </p>
                            ${model.description ? `<p class="mb-2">${model.description}</p>` : '<p class="text-muted mb-2"><em>No description</em></p>'}
                            ${metricsHtml ? `<p class="mb-2">${metricsHtml}</p>` : ''}
                            <p class="text-muted small mb-0">
                                <i class="fas fa-calendar me-1"></i>Stored: ${new Date(model.created_at).toLocaleString()}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group-vertical w-100" role="group">
                                <button class="btn btn-sm btn-outline-primary mb-2" onclick="viewModelDetails('${model.name}')">
                                    <i class="fas fa-eye me-2"></i>View Details
                                </button>
                                <button class="btn btn-sm btn-outline-warning mb-2" onclick="openEditModal('${model.name}')">
                                    <i class="fas fa-edit me-2"></i>Edit
                                </button>
                                <button class="btn btn-sm btn-outline-success mb-2" onclick="downloadModel('${model.name}')">
                                    <i class="fas fa-download me-2"></i>Download
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteModel('${model.name}')">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function openStoreModal(runId) {
            // Find model data
            const model = modelsData.trained_models.find(m => m.run_id === runId);
            if (!model) {
                alert('Model not found');
                return;
            }
            
            document.getElementById('storeRunId').value = runId;
            document.getElementById('storeModelName').value = `model_${runId}`;
            document.getElementById('storeVersion').value = '1.0';
            document.getElementById('storeDescription').value = '';
            
            // Show metrics
            const metricsDiv = document.getElementById('storeModelMetrics');
            let metricsHtml = '<strong>Training Metrics:</strong><br>';
            if (model.epochs) metricsHtml += `Epochs: ${model.epochs} | `;
            if (model.loss) metricsHtml += `Loss: ${model.loss.toFixed(4)} | `;
            if (model.metrics) {
                if (model.metrics.mAP50) metricsHtml += `mAP50: ${(model.metrics.mAP50 * 100).toFixed(1)}% | `;
                if (model.metrics['mAP50-95']) metricsHtml += `mAP50-95: ${(model.metrics['mAP50-95'] * 100).toFixed(1)}%`;
            }
            metricsDiv.innerHTML = metricsHtml;
            
            const modal = new bootstrap.Modal(document.getElementById('storeModelModal'));
            modal.show();
        }

        async function confirmStoreModel() {
            const runId = document.getElementById('storeRunId').value;
            const name = document.getElementById('storeModelName').value;
            const version = document.getElementById('storeVersion').value;
            const description = document.getElementById('storeDescription').value;
            
            if (!name.trim()) {
                alert('Please enter a model name');
                return;
            }
            
            try {
                const response = await fetch(`/level/3/projects/${currentProjectId}/store-model`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        run_id: runId,
                        name: name,
                        version: version,
                        description: description
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('storeModelModal'));
                    modal.hide();
                    
                    alert('Model stored successfully!');
                    await loadModels();
                } else {
                    alert('Error storing model: ' + data.error);
                }
            } catch (error) {
                alert('Error storing model: ' + error.message);
            }
        }

        async function viewModelDetails(modelName) {
            try {
                const response = await fetch(`/level/3/projects/${currentProjectId}/models/${modelName}/metadata`);
                const data = await response.json();
                
                if (data.success) {
                    const metadata = data.metadata;
                    let details = `Model: ${metadata.model_name}\n\n`;
                    details += `Version: ${metadata.version}\n`;
                    details += `Description: ${metadata.description || 'N/A'}\n\n`;
                    details += `Training Information:\n`;
                    details += `- Epochs: ${metadata.training_epochs}\n`;
                    details += `- Loss: ${metadata.training_loss || 'N/A'}\n`;
                    if (metadata.metrics) {
                        details += `- mAP50: ${metadata.metrics.mAP50 ? (metadata.metrics.mAP50 * 100).toFixed(1) + '%' : 'N/A'}\n`;
                        details += `- mAP50-95: ${metadata.metrics['mAP50-95'] ? (metadata.metrics['mAP50-95'] * 100).toFixed(1) + '%' : 'N/A'}\n`;
                    }
                    details += `\nStorage Information:\n`;
                    details += `- Stored at: ${new Date(metadata.stored_at).toLocaleString()}\n`;
                    details += `- File size: ${(metadata.file_size_bytes / (1024 * 1024)).toFixed(2)} MB\n`;
                    
                    alert(details);
                } else {
                    alert('Error loading model details');
                }
            } catch (error) {
                alert('Error loading model details: ' + error.message);
            }
        }

        async function openEditModal(modelName) {
            try {
                const response = await fetch(`/level/3/projects/${currentProjectId}/models/${modelName}/metadata`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('editModelName').value = modelName;
                    document.getElementById('editVersion').value = data.metadata.version || '1.0';
                    document.getElementById('editDescription').value = data.metadata.description || '';
                    
                    const modal = new bootstrap.Modal(document.getElementById('editModelModal'));
                    modal.show();
                } else {
                    alert('Error loading model metadata');
                }
            } catch (error) {
                alert('Error loading model metadata: ' + error.message);
            }
        }

        async function confirmUpdateModel() {
            const modelName = document.getElementById('editModelName').value;
            const version = document.getElementById('editVersion').value;
            const description = document.getElementById('editDescription').value;
            
            try {
                const response = await fetch(`/level/3/projects/${currentProjectId}/models/${modelName}/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        version: version,
                        description: description
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editModelModal'));
                    modal.hide();
                    
                    alert('Model metadata updated successfully!');
                    await loadModels();
                } else {
                    alert('Error updating model: ' + data.error);
                }
            } catch (error) {
                alert('Error updating model: ' + error.message);
            }
        }

        function downloadModel(modelName) {
            window.location.href = `/level/3/projects/${currentProjectId}/models/${modelName}/download`;
        }

        async function deleteModel(modelName) {
            if (!confirm(`Are you sure you want to delete "${modelName}"? This cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/level/3/projects/${currentProjectId}/models/${modelName}/delete`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Model deleted successfully!');
                    await loadModels();
                } else {
                    alert('Error deleting model: ' + data.error);
                }
            } catch (error) {
                alert('Error deleting model: ' + error.message);
            }
        }
    </script>
</body>
</html>

