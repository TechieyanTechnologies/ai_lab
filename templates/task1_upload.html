<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 1: Upload & Preview Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .task-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; }
        .learning-objective { background: #f8f9fa; padding: 1rem; border-left: 4px solid #667eea; }
        .preview-table { max-height: 500px; overflow-y: auto; font-size: 0.9rem; }
        .stats-card { border: 1px solid #dee2e6; border-radius: 0.5rem; padding: 1rem; margin: 0.5rem 0; }
    </style>
</head>
<body>
    <div class="task-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-upload me-3"></i>Task 1: Upload & Preview Dataset</h1>
                    <p class="lead mb-0">Learn the fundamentals of working with CSV data</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-light text-dark me-2" style="font-size: 0.9rem;">
                        <i class="fas fa-clock me-1"></i>15 minutes
                    </span>
                    <a href="/level/1/task/1/document" target="_blank" class="btn btn-light btn-sm">
                        <i class="fas fa-book me-2"></i>Document
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Learning Objective -->
        <div class="learning-objective mb-4">
            <h4><i class="fas fa-bullseye me-2"></i>Learning Objective</h4>
            <p class="mb-0">
                By the end of this task, you will be able to upload a CSV file, understand its structure,
                identify column types, detect missing values, and preview the data effectively.
            </p>
        </div>

        <!-- Step 1: Upload -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-step-forward me-2"></i>Step 1: Upload Your CSV File</h4>
            </div>
            <div class="card-body">
                <p>Upload a CSV file to start your data analysis journey. You can use:</p>
                <ul>
                    <li>Sample data from <code>seed_data/level1/</code></li>
                    <li>Your own CSV file</li>
                    <li>Data exported from Excel or Google Sheets</li>
                </ul>
                
                <form id="uploadForm" class="mt-4">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">Select CSV File *</label>
                        <input type="file" class="form-control form-control-lg" id="csvFile" accept=".csv" required>
                        <div class="form-text">Supported format: CSV files (.csv) up to 10MB</div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Upload CSV
                    </button>
                </form>

                <!-- Sample Files -->
                <div class="mt-4">
                    <h6>Quick Start - Use Sample Data:</h6>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="loadSample('student_marks')">
                            <i class="fas fa-file-csv me-2"></i>Student Marks
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="loadSample('weather_week')">
                            <i class="fas fa-cloud me-2"></i>Weather Data
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="loadSample('sales_small')">
                            <i class="fas fa-chart-line me-2"></i>Sales Data
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="loadSample('survey_small')">
                            <i class="fas fa-clipboard-check me-2"></i>Survey Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Activities Menu -->
        <div class="card mb-4" id="activitiesMenu" style="display: none;">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="fas fa-tasks me-2"></i>Interactive Activities</h4>
            </div>
            <div class="card-body">
                <p>Choose an activity to explore your data in different ways:</p>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-search fa-3x text-primary mb-2"></i>
                                <h5>Data Detective</h5>
                                <p class="small">Find columns, count rows, identify types</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="startActivity('detective')">
                                    Start Activity
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-pie fa-3x text-success mb-2"></i>
                                <h5>Quick Analyzer</h5>
                                <p class="small">Analyze one column in depth</p>
                                <button class="btn btn-outline-success btn-sm" onclick="startActivity('analyzer')">
                                    Start Activity
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-puzzle-piece fa-3x text-warning mb-2"></i>
                                <h5>Column Matcher</h5>
                                <p class="small">Match columns to their types</p>
                                <button class="btn btn-outline-warning btn-sm" onclick="startActivity('matcher')">
                                    Start Activity
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-brain fa-3x text-info mb-2"></i>
                                <h5>Pattern Finder</h5>
                                <p class="small">Discover patterns in your data</p>
                                <button class="btn btn-outline-info btn-sm" onclick="startActivity('pattern')">
                                    Start Activity
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-crosshairs fa-3x text-danger mb-2"></i>
                                <h5>Value Hunter</h5>
                                <p class="small">Search for specific values</p>
                                <button class="btn btn-outline-danger btn-sm" onclick="startActivity('hunter')">
                                    Start Activity
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-sitemap fa-3x text-dark mb-2"></i>
                                <h5>Data Explorer</h5>
                                <p class="small">Compare multiple columns</p>
                                <button class="btn btn-outline-dark btn-sm" onclick="startActivity('explorer')">
                                    Start Activity
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Result Display (below activities menu) -->
        <div class="card mb-4" id="activityResult" style="display: none;">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0"><i class="fas fa-star me-2"></i>Activity Result</h4>
            </div>
            <div class="card-body">
                <div id="activityResultContent"></div>
            </div>
        </div>

        <!-- Step 2: Preview -->
        <div class="card mb-4" id="previewSection" style="display: none;">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="fas fa-eye me-2"></i>Step 2: Explore Your Data</h4>
            </div>
            <div class="card-body">
                <div id="previewContent"></div>
            </div>
        </div>

        <!-- Activity Results -->
        <div class="card mb-4" id="activityResult" style="display: none;">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0"><i class="fas fa-star me-2"></i>Activity Result</h4>
            </div>
            <div class="card-body">
                <div id="activityContent"></div>
            </div>
        </div>

        <!-- Understanding Your Data -->
        <div class="card mb-4" id="understandingSection" style="display: none;">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Understanding Your Data</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-table me-2"></i>Data Structure</h5>
                        <div id="structureInfo"></div>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-chart-bar me-2"></i>Column Types</h5>
                        <div id="typesInfo"></div>
                    </div>
                </div>
                <div class="mt-3">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Data Quality</h5>
                    <div id="qualityInfo"></div>
                </div>
            </div>
        </div>

        <!-- Key Concepts -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0"><i class="fas fa-book me-2"></i>Key Concepts Learned</h4>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>CSV Format:</strong> Comma-Separated Values - rows and columns structure
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Column Types:</strong> Numeric (numbers) vs Categorical (text) vs DateTime (dates)
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Missing Values:</strong> Empty cells that need special handling
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Data Preview:</strong> View first 20 rows to understand structure
                    </li>
                </ul>
            </div>
        </div>

        <!-- Navigation -->
        <div class="card">
            <div class="card-body text-center">
                <a href="/level/1" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Back to Tasks
                </a>
                <button class="btn btn-primary" id="nextTaskBtn" style="display: none;" onclick="window.location.href='/level/1/task/2'">
                    Next Task <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentProjectId = localStorage.getItem('currentProjectId');

        async function loadSample(filename) {
            try {
                const response = await fetch(`/level/1/load-sample/${filename}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    currentProjectId = data.project_id;
                    localStorage.setItem('currentProjectId', currentProjectId);
                    await loadPreview(data.project_id);
                } else {
                    alert('Error loading sample: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading sample:', error);
                alert('Error loading sample: ' + error.message);
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = document.getElementById('csvFile').files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/level/1/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    currentProjectId = data.project_id;
                    localStorage.setItem('currentProjectId', currentProjectId);
                    await loadPreview(data.project_id);
                }
            } catch (error) {
                alert('Error: ' + error);
            }
        });

        async function loadPreview(projectId) {
            const response = await fetch(`/projects/${projectId}/dataset/preview`);
            const data = await response.json();
            
            // Store dataset info for activities
            datasetInfo = data;
            
            // Show preview section (at the end)
            document.getElementById('previewSection').style.display = 'block';
            
            // Show activities menu (before preview)
            document.getElementById('activitiesMenu').style.display = 'block';
            
            // Build preview table
            let html = '<div class="mb-3"><h5>Dataset Shape: <span class="badge bg-info">' + 
                       data.shape[0] + ' rows √ó ' + data.shape[1] + ' columns</span></h5></div>';
            
            html += '<div class="preview-table"><table class="table table-striped table-bordered table-sm">';
            
            // Header
            html += '<thead class="table-dark"><tr>';
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Rows
            data.head.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    html += `<td>${row[col] !== null ? row[col] : '<em class="text-muted">missing</em>'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('previewContent').innerHTML = html;
            
            // Update understanding section
            updateUnderstanding(data);
            
            // Show next button
            document.getElementById('nextTaskBtn').style.display = 'inline-block';
        }

        function updateUnderstanding(data) {
            let html = '';
            
            // Structure
            html = '<div class="stats-card">';
            html += '<p><strong>Total Rows:</strong> ' + data.shape[0] + '</p>';
            html += '<p><strong>Total Columns:</strong> ' + data.shape[1] + '</p>';
            html += '<p><strong>Column Names:</strong> ' + data.columns.join(', ') + '</p>';
            html += '</div>';
            document.getElementById('structureInfo').innerHTML = html;
            
            // Types
            html = '<div id="typesList"></div>';
            document.getElementById('typesInfo').innerHTML = html;
            
            let typesHtml = '';
            Object.keys(data.dtypes).forEach(col => {
                const dtype = data.dtypes[col];
                typesHtml += `<div class="stats-card">`;
                typesHtml += `<strong>${col}</strong>: <code>${dtype}</code>`;
                typesHtml += `</div>`;
            });
            document.getElementById('typesList').innerHTML = typesHtml;
            
            // Quality
            html = '<div id="qualityList"></div>';
            document.getElementById('qualityInfo').innerHTML = html;
            
            let qualityHtml = '';
            Object.keys(data.missing).forEach(col => {
                const missing = data.missing[col];
                if (missing > 0) {
                    qualityHtml += `<div class="stats-card alert-warning">`;
                    qualityHtml += `<strong>${col}</strong>: ${missing} missing values`;
                    qualityHtml += `</div>`;
                }
            });
            if (!qualityHtml) {
                qualityHtml = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>No missing values detected!</div>';
            }
            document.getElementById('qualityList').innerHTML = qualityHtml;
            
            document.getElementById('understandingSection').style.display = 'block';
        }

        // Activity functions
        let datasetInfo = null;
        let currentActivity = null;

        function backToActivities() {
            document.getElementById('activityResult').style.display = 'none';
            currentActivity = null;
        }

        async function startActivity(type) {
            if (!currentProjectId) {
                alert('Please load a dataset first!');
                return;
            }

            if (!datasetInfo) {
                const response = await fetch(`/projects/${currentProjectId}/dataset/preview`);
                datasetInfo = await response.json();
            }

            // Show activity result (keep menu visible)
            document.getElementById('activityResult').style.display = 'block';
            
            currentActivity = type;
            const contentDiv = document.getElementById('activityResultContent');

            // Scroll to result section
            document.getElementById('activityResult').scrollIntoView({ behavior: 'smooth', block: 'start' });

            if (type === 'detective') {
                runDataDetective(contentDiv);
            } else if (type === 'analyzer') {
                runQuickAnalyzer(contentDiv);
            } else if (type === 'matcher') {
                runColumnMatcher(contentDiv);
            } else if (type === 'pattern') {
                runPatternFinder(contentDiv);
            } else if (type === 'hunter') {
                runValueHunter(contentDiv);
            } else if (type === 'explorer') {
                runDataExplorer(contentDiv);
            }
        }

        function runDataDetective(contentDiv) {
            let html = '<h5>üîç Data Detective Challenge</h5>';
            html += '<p>Answer these questions about your dataset:</p>';
            html += '<div class="row g-3">';
            
            const questions = [
                { 
                    q: 'How many rows are in this dataset?', 
                    a: datasetInfo.shape[0],
                    input: `<input type="number" id="q1" class="form-control" placeholder="Enter number">`
                },
                { 
                    q: 'How many columns are in this dataset?', 
                    a: datasetInfo.shape[1],
                    input: `<input type="number" id="q1_col" class="form-control" placeholder="Enter number">`
                },
                { 
                    q: 'What is the name of the first column?', 
                    a: datasetInfo.columns[0],
                    input: `<input type="text" id="q1_colname" class="form-control" placeholder="Enter column name">`
                }
            ];

            questions.forEach((q, i) => {
                html += `<div class="col-md-4">`;
                html += `<div class="alert alert-secondary">${q.q}</div>`;
                html += q.input;
                html += `<div class="mt-2" id="result${i+1}"></div>`;
                html += `</div>`;
            });

            html += '</div>';
            html += '<button class="btn btn-primary mt-3" onclick="checkDetectiveAnswers()">Check Answers</button>';
            html += `<div id="detectiveScore" class="mt-3"></div>`;

            contentDiv.innerHTML = html;
            window.detectiveAnswers = questions;
        }

        function checkDetectiveAnswers() {
            const answers = [
                { input: 'q1', expected: window.detectiveAnswers[0].a },
                { input: 'q1_col', expected: window.detectiveAnswers[1].a },
                { input: 'q1_colname', expected: window.detectiveAnswers[2].a }
            ];

            let correct = 0;
            answers.forEach((a, i) => {
                const userAnswer = document.getElementById(a.input).value;
                const isCorrect = userAnswer.toString().toLowerCase() === a.expected.toString().toLowerCase();
                const resultDiv = document.getElementById(`result${i+1}`);
                
                if (isCorrect) {
                    resultDiv.innerHTML = '<span class="badge bg-success">‚úì Correct!</span>';
                    correct++;
                } else {
                    resultDiv.innerHTML = '<span class="badge bg-danger">‚úó Wrong. Expected: ' + a.expected + '</span>';
                }
            });

            const scoreDiv = document.getElementById('detectiveScore');
            scoreDiv.innerHTML = `<div class="alert alert-info"><strong>Score: ${correct}/${answers.length}</strong> You got ${correct} out of ${answers.length} questions correct!</div>`;
        }

        function runQuickAnalyzer(contentDiv) {
            let html = '<h5>üìä Quick Analyzer</h5>';
            html += '<p>Select a column to analyze:</p>';
            html += '<select class="form-select mb-3" id="analyzeColumn">';
            datasetInfo.columns.forEach(col => {
                html += `<option value="${col}">${col}</option>`;
            });
            html += '</select>';
            html += '<button class="btn btn-success" onclick="analyzeColumn()">Analyze Column</button>';
            html += '<div id="analyzeResult" class="mt-3"></div>';

            contentDiv.innerHTML = html;
        }

        function analyzeColumn() {
            const column = document.getElementById('analyzeColumn').value;
            const dtype = datasetInfo.dtypes[column];
            const missing = datasetInfo.missing[column];

            let html = '<div class="alert alert-success">';
            html += `<h6>Column Analysis: ${column}</h6>`;
            html += `<p><strong>Type:</strong> ${dtype}</p>`;
            html += `<p><strong>Missing Values:</strong> ${missing} (${((missing/datasetInfo.shape[0])*100).toFixed(1)}%)</p>`;
            html += `<p><strong>Complete Values:</strong> ${datasetInfo.shape[0] - missing} (${(((datasetInfo.shape[0]-missing)/datasetInfo.shape[0])*100).toFixed(1)}%)</p>`;
            
            if (dtype.includes('int') || dtype.includes('float')) {
                html += '<p class="text-info"><i class="fas fa-info-circle me-1"></i>This is a numeric column - perfect for calculations!</p>';
            } else if (dtype.includes('object')) {
                html += '<p class="text-info"><i class="fas fa-info-circle me-1"></i>This is a text column - great for categories!</p>';
            }
            
            html += '</div>';
            document.getElementById('analyzeResult').innerHTML = html;
        }

        function runColumnMatcher(contentDiv) {
            let html = '<h5>üß© Column Type Matcher</h5>';
            html += '<p>Match each column to its correct type!</p>';
            
            // Shuffle columns
            const shuffled = datasetInfo.columns.sort(() => Math.random() - 0.5);
            const types = ['Numeric', 'Text', 'Date'];
            
            html += '<div class="row">';
            shuffled.slice(0, 6).forEach((col, i) => {
                const correctType = datasetInfo.dtypes[col].includes('int') || datasetInfo.dtypes[col].includes('float') 
                    ? 'Numeric' : datasetInfo.dtypes[col].includes('datetime') ? 'Date' : 'Text';
                
                html += `<div class="col-md-6 mb-3">`;
                html += `<div class="card">`;
                html += `<div class="card-body">`;
                html += `<h6>Column ${i+1}: <code>${col}</code></h6>`;
                html += `<select class="form-select matchType${i}" id="match${i}">`;
                html += `<option value="">Choose type...</option>`;
                types.forEach(t => {
                    html += `<option value="${t}">${t}</option>`;
                });
                html += `</select>`;
                html += `<div class="mt-2" id="matchResult${i}"></div>`;
                html += `</div></div></div>`;
                
                // Store correct answer
                window[`correctMatch${i}`] = correctType;
            });
            
            html += '</div>';
            html += '<button class="btn btn-warning" onclick="checkMatches()">Check Matches</button>';
            html += '<div id="matcherScore" class="mt-3"></div>';

            contentDiv.innerHTML = html;
        }

        function checkMatches() {
            let correct = 0;
            let total = 0;
            
            for (let i = 0; i < 6; i++) {
                const matchSelect = document.querySelector(`.matchType${i}`);
                if (matchSelect) {
                    total++;
                    const userChoice = matchSelect.value;
                    const correctAnswer = window[`correctMatch${i}`];
                    const resultDiv = document.getElementById(`matchResult${i}`);
                    
                    if (userChoice === correctAnswer) {
                        resultDiv.innerHTML = '<span class="badge bg-success">‚úì Correct!</span>';
                        correct++;
                    } else {
                        resultDiv.innerHTML = '<span class="badge bg-danger">‚úó Wrong. Correct: ' + correctAnswer + '</span>';
                    }
                }
            }

            const scoreDiv = document.getElementById('matcherScore');
            scoreDiv.innerHTML = `<div class="alert alert-info"><strong>Score: ${correct}/${total}</strong> You matched ${correct} out of ${total} columns correctly!</div>`;
        }

        function runPatternFinder(contentDiv) {
            let html = '<h5>üß† Pattern Finder</h5>';
            html += '<p class="alert alert-info"><i class="fas fa-lightbulb me-2"></i>Discover interesting patterns in your data!</p>';
            
            // Find numeric columns for pattern analysis
            const numericCols = datasetInfo.columns.filter(col => 
                datasetInfo.dtypes[col].includes('int') || datasetInfo.dtypes[col].includes('float')
            );
            
            html += '<div class="row">';
            numericCols.slice(0, 3).forEach((col, i) => {
                const values = datasetInfo.head.map(row => parseFloat(row[col])).filter(v => !isNaN(v));
                const avg = values.reduce((a, b) => a + b, 0) / values.length;
                const min = Math.min(...values);
                const max = Math.max(...values);
                
                html += `<div class="col-md-4 mb-3">`;
                html += `<div class="card">`;
                html += `<div class="card-body">`;
                html += `<h6>Column: <code>${col}</code></h6>`;
                html += `<p><strong>Pattern:</strong></p>`;
                html += `<p>Average: <strong>${avg.toFixed(2)}</strong></p>`;
                html += `<p>Range: ${min.toFixed(2)} to ${max.toFixed(2)}</p>`;
                if (max > avg * 2) {
                    html += `<p class="text-warning">‚ö†Ô∏è Has very high values!</p>`;
                } else if (max < avg * 1.2) {
                    html += `<p class="text-success">‚úì Values are quite consistent</p>`;
                }
                html += `</div></div></div>`;
            });
            html += '</div>';
            
            html += '<div class="alert alert-success mt-3">';
            html += '<h6>üí° What did you learn?</h6>';
            html += '<p>Patterns help you understand if your data is:</p>';
            html += '<ul>';
            html += '<li><strong>Consistent:</strong> Values stay in a similar range</li>';
            html += '<li><strong>Variable:</strong> Values change significantly</li>';
            html += '<li><strong>Extreme:</strong> Has very high or low outliers</li>';
            html += '</ul></div>';
            
            contentDiv.innerHTML = html;
        }

        function runValueHunter(contentDiv) {
            let html = '<h5>üéØ Value Hunter</h5>';
            html += '<p class="alert alert-danger"><i class="fas fa-crosshairs me-2"></i>Find specific values in your dataset!</p>';
            
            // Pick a random column and value
            const randomCol = datasetInfo.columns[Math.floor(Math.random() * datasetInfo.columns.length)];
            const nonNullValues = datasetInfo.head
                .map(row => row[randomCol])
                .filter(v => v !== null && v !== undefined);
            const randomValue = nonNullValues[Math.floor(Math.random() * nonNullValues.length)];
            
            html += `<div class="alert alert-warning">`;
            html += `<h6>üéØ Your Mission:</h6>`;
            html += `<p>Find how many times the value <strong>"${randomValue}"</strong> appears in column <code>${randomCol}</code></p>`;
            html += `</div>`;
            
            // Count actual occurrences
            const actualCount = datasetInfo.head.filter(row => row[randomCol] === randomValue).length;
            
            html += `<div class="mb-3">`;
            html += `<label>Your guess:</label>`;
            html += `<input type="number" class="form-control" id="hunterGuess" placeholder="Enter number">`;
            html += `<button class="btn btn-danger mt-2" onclick="checkHunterAnswer(${actualCount})">Check Answer</button>`;
            html += `</div>`;
            
            html += `<div id="hunterResult"></div>`;
            
            contentDiv.innerHTML = html;
            
            window.hunterAnswer = actualCount;
        }

        function checkHunterAnswer(correct) {
            const guess = document.getElementById('hunterGuess').value;
            const resultDiv = document.getElementById('hunterResult');
            
            if (parseInt(guess) === correct) {
                resultDiv.innerHTML = '<div class="alert alert-success">üéâ Correct! You found ' + correct + ' occurrence(s)!</div>';
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚úó Wrong! The correct answer is ' + correct + ' occurrence(s).</div>';
            }
        }

        function runDataExplorer(contentDiv) {
            let html = '<h5>üó∫Ô∏è Data Explorer</h5>';
            html += '<p class="alert alert-dark"><i class="fas fa-sitemap me-2"></i>Compare and explore relationships in your data!</p>';
            
            // Select two columns to compare
            html += '<div class="row mb-3">';
            html += '<div class="col-md-6">';
            html += '<label class="form-label">Select First Column:</label>';
            html += '<select class="form-select" id="exploreCol1">';
            datasetInfo.columns.forEach(col => {
                html += `<option value="${col}">${col}</option>`;
            });
            html += '</select>';
            html += '</div>';
            
            html += '<div class="col-md-6">';
            html += '<label class="form-label">Select Second Column:</label>';
            html += '<select class="form-select" id="exploreCol2">';
            datasetInfo.columns.forEach(col => {
                html += `<option value="${col}" selected>${col}</option>`;
            });
            html += '</select>';
            html += '</div>';
            html += '</div>';
            
            html += '<button class="btn btn-dark" onclick="compareColumns()">Compare Columns</button>';
            html += '<div id="compareResult" class="mt-3"></div>';
            
            contentDiv.innerHTML = html;
        }

        function compareColumns() {
            const col1 = document.getElementById('exploreCol1').value;
            const col2 = document.getElementById('exploreCol2').value;
            const resultDiv = document.getElementById('compareResult');
            
            if (col1 === col2) {
                resultDiv.innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Please select two different columns!</div>';
                return;
            }
            
            // Calculate comparison metrics
            const dtype1 = datasetInfo.dtypes[col1];
            const dtype2 = datasetInfo.dtypes[col2];
            const missing1 = datasetInfo.missing[col1];
            const missing2 = datasetInfo.missing[col2];
            
            let html = '<div class="card">';
            html += '<div class="card-header bg-dark text-white"><h6>Column Comparison</h6></div>';
            html += '<div class="card-body">';
            html += '<div class="row">';
            
            // Column 1 info
            html += '<div class="col-md-6">';
            html += `<h6><code>${col1}</code></h6>`;
            html += `<p><strong>Type:</strong> ${dtype1}</p>`;
            html += `<p><strong>Missing Values:</strong> ${missing1}</p>`;
            html += `<p><strong>Complete:</strong> ${datasetInfo.shape[0] - missing1}</p>`;
            html += '</div>';
            
            // Column 2 info
            html += '<div class="col-md-6">';
            html += `<h6><code>${col2}</code></h6>`;
            html += `<p><strong>Type:</strong> ${dtype2}</p>`;
            html += `<p><strong>Missing Values:</strong> ${missing2}</p>`;
            html += `<p><strong>Complete:</strong> ${datasetInfo.shape[0] - missing2}</p>`;
            html += '</div>';
            
            html += '</div>';
            
            // Comparative insights
            html += '<hr>';
            html += '<h6>üí° Insights:</h6>';
            html += '<ul>';
            
            if (dtype1 === dtype2) {
                html += '<li class="text-success">‚úì Both columns have the same data type!</li>';
            } else {
                html += '<li class="text-warning">‚ö†Ô∏è These columns have different types</li>';
            }
            
            if (missing1 === 0 && missing2 === 0) {
                html += '<li class="text-success">‚úì Both columns have no missing values - great quality!</li>';
            } else if (missing1 > missing2) {
                html += '<li class="text-info">Column 1 has more missing values than Column 2</li>';
            } else if (missing2 > missing1) {
                html += '<li class="text-info">Column 2 has more missing values than Column 1</li>';
            }
            
            html += '</ul>';
            html += '</div></div>';
            
            resultDiv.innerHTML = html;
        }

        // Load existing project if available
        if (currentProjectId) {
            fetch(`/projects/${currentProjectId}/dataset/preview`)
            .then(r => r.json())
            .then(data => {
                if (!data.error) {
                    loadPreview(currentProjectId);
                }
            });
        }
    </script>
</body>
</html>
