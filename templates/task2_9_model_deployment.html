<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 2.9: Model Deployment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .task-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; }
        .learning-objective { background: #f8f9fa; padding: 1rem; border-left: 4px solid #667eea; }
        .activity-card { background: #fff; border: 2px solid #667eea; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; }
        .activity-card h6 { color: #667eea; font-weight: bold; }
        #deploymentResult { min-height: 200px; background: white; border: 1px solid #dee2e6; padding: 1.5rem; }
        .deployment-card { background: #f8f9fa; border-left: 4px solid #667eea; padding: 1rem; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="task-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-rocket me-3"></i>Task 2.9: Model Deployment</h1>
                    <p class="lead mb-0">Deploy your trained model for real-world use</p>
                </div>
                <div class="text-end">
                    <a href="/level/2" class="btn btn-light me-2">‚Üê Back to Level 2</a>
                    <span class="badge bg-light text-dark me-2" style="font-size: 0.9rem;">
                        <i class="fas fa-clock me-1"></i>25 minutes
                    </span>
                    <a href="/level/2/task/9/document" target="_blank" class="btn btn-light btn-sm">
                        <i class="fas fa-book me-2"></i>Document
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Learning Objective -->
        <div class="learning-objective mb-4">
            <h4><i class="fas fa-bullseye me-2"></i>Learning Objective</h4>
            <p class="mb-0">Learn to deploy machine learning models by creating prediction APIs, building simple web interfaces, and understanding deployment considerations for production use.</p>
        </div>

        <!-- Dataset Selection -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h4><i class="fas fa-database me-2"></i>Select Your Dataset</h4>
            </div>
            <div class="card-body">
                <p>Choose a dataset for model deployment:</p>
                
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="loadSample('housing_small')">
                        <i class="fas fa-home me-2"></i>Housing Data
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadSample('student_performance')">
                        <i class="fas fa-graduation-cap me-2"></i>Student Performance
                    </button>
                </div>
                <div id="datasetStatus" class="mt-3"></div>
                
                <!-- Data Preview Section -->
                <div id="dataPreview" class="mt-4" style="display: none;">
                    <h6><i class="fas fa-eye me-2"></i>Dataset Preview</h6>
                    <div id="dataInfo" class="alert alert-info mb-3"></div>
                    <div id="dataTable" class="table-responsive"></div>
                </div>
            </div>
        </div>

        <!-- Deployment Options -->
        <div class="card mb-4" id="deploymentCard" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-cloud me-2"></i>Deployment Options</h5>
            </div>
            <div class="card-body">
                <p class="mb-4">Choose how to deploy your model:</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="deployment-card">
                            <h6><i class="fas fa-code me-2"></i>API Endpoint</h6>
                            <p class="small">Create a REST API for model predictions</p>
                            <button onclick="createAPI()" class="btn btn-primary btn-sm">Create API</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="deployment-card">
                            <h6><i class="fas fa-globe me-2"></i>Web Interface</h6>
                            <p class="small">Build a simple web form for predictions</p>
                            <button onclick="createWebInterface()" class="btn btn-primary btn-sm">Create Interface</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="deployment-card">
                            <h6><i class="fas fa-file-code me-2"></i>Python Script</h6>
                            <p class="small">Generate a standalone prediction script</p>
                            <button onclick="createPythonScript()" class="btn btn-primary btn-sm">Generate Script</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="deployment-card">
                            <h6><i class="fas fa-docker me-2"></i>Docker Container</h6>
                            <p class="small">Package model in a Docker container</p>
                            <button onclick="createDockerContainer()" class="btn btn-primary btn-sm">Create Container</button>
                        </div>
                    </div>
                </div>
                
                <div id="deploymentResult" class="mt-4"></div>
            </div>
        </div>

        <!-- Interactive Activities -->
        <div class="card mb-4" id="activitiesCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-hands-on me-2"></i>Hands-on Activities</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="activity-card">
                            <h6><i class="fas fa-play"></i> Test Predictions</h6>
                            <p class="small">Test your deployed model with sample data</p>
                            <button onclick="testPredictions()" class="btn btn-success btn-sm w-100">Test</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="activity-card">
                            <h6><i class="fas fa-chart-line"></i> Monitor Performance</h6>
                            <p class="small">Monitor model performance in production</p>
                            <button onclick="monitorPerformance()" class="btn btn-success btn-sm w-100">Monitor</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="activity-card">
                            <h6><i class="fas fa-download"></i> Download Artifacts</h6>
                            <p class="small">Download deployment files and documentation</p>
                            <button onclick="downloadArtifacts()" class="btn btn-success btn-sm w-100">Download</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="activity-card">
                            <h6><i class="fas fa-share"></i> Share Model</h6>
                            <p class="small">Share your deployed model with others</p>
                            <button onclick="shareModel()" class="btn btn-success btn-sm w-100">Share</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="card">
            <div class="card-body text-center">
                <a href="/level/2/task/8" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Previous Task
                </a>
                <a href="/level/2/task/10" class="btn btn-primary">
                    Next Task <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentProjectId = localStorage.getItem('currentProjectId');

        // Load dataset if available
        if (currentProjectId) {
            document.getElementById('datasetStatus').innerHTML = '<div class="alert alert-success">Dataset loaded! Project ID: ' + currentProjectId + '</div>';
            document.getElementById('deploymentCard').style.display = 'block';
            document.getElementById('activitiesCard').style.display = 'block';
        }

        async function loadSample(filename) {
            if (!filename) { alert('Please select a dataset'); return; }

            try {
                const response = await fetch(`/level/2/load-sample/${filename}`, { method: 'POST' });
                const data = await response.json();

                if (data.project_id) {
                    currentProjectId = data.project_id;
                    localStorage.setItem('currentProjectId', currentProjectId);
                    document.getElementById('datasetStatus').innerHTML = `<div class="alert alert-success">Sample loaded! Project ID: ${currentProjectId}</div>`;
                    document.getElementById('deploymentCard').style.display = 'block';
                    document.getElementById('activitiesCard').style.display = 'block';
                    loadDatasetInfo();
                }
            } catch (error) {
                alert('Error loading sample: ' + error.message);
            }
        }

        async function loadDatasetInfo() {
            try {
                const response = await fetch(`/projects/${currentProjectId}/columns`);
                const data = await response.json();
                
                // Show data preview
                showDataPreview(data);
                
                document.getElementById('datasetStatus').innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Dataset loaded: ${data.shape[0]} rows, ${data.shape[1]} columns</div>`;
            } catch (error) {
                console.error('Error loading dataset info:', error);
            }
        }

        async function showDataPreview(data) {
            // Show data info
            let infoHtml = `<h6>üìä Dataset Information:</h6>`;
            infoHtml += `<div class="row">`;
            infoHtml += `<div class="col-md-6">`;
            infoHtml += `<p><strong>Total Rows:</strong> ${data.shape[0]}</p>`;
            infoHtml += `<p><strong>Total Columns:</strong> ${data.shape[1]}</p>`;
            infoHtml += `</div>`;
            infoHtml += `<div class="col-md-6">`;
            infoHtml += `<p><strong>Numeric Columns:</strong> ${data.numeric_columns.length}</p>`;
            infoHtml += `<p><strong>Categorical Columns:</strong> ${data.columns.length - data.numeric_columns.length}</p>`;
            infoHtml += `</div>`;
            infoHtml += `</div>`;
            
            document.getElementById('dataInfo').innerHTML = infoHtml;
            
            // Show data table preview
            try {
                const previewResponse = await fetch(`/projects/${currentProjectId}/dataset/preview`);
                const previewData = await previewResponse.json();
                
                let tableHtml = `<table class="table table-sm table-striped">`;
                tableHtml += `<thead><tr>`;
                previewData.columns.forEach(col => {
                    const isNumeric = data.numeric_columns.includes(col);
                    const icon = isNumeric ? 'fas fa-calculator' : 'fas fa-tag';
                    tableHtml += `<th><i class="${icon} me-1"></i>${col}</th>`;
                });
                tableHtml += `</tr></thead><tbody>`;
                
                // Convert head data (list of objects) to array format
                previewData.head.slice(0, 10).forEach(row => {
                    tableHtml += `<tr>`;
                    previewData.columns.forEach(col => {
                        tableHtml += `<td>${row[col]}</td>`;
                    });
                    tableHtml += `</tr>`;
                });
                tableHtml += `</tbody></table>`;
                
                if (previewData.head.length > 10) {
                    tableHtml += `<p class="small text-muted">Showing first 10 rows of ${previewData.head.length} total rows</p>`;
                }
                
                document.getElementById('dataTable').innerHTML = tableHtml;
                document.getElementById('dataPreview').style.display = 'block';
            } catch (error) {
                console.error('Error loading data preview:', error);
            }
        }

        async function createAPI() {
            let html = '<h6><i class="fas fa-code text-success me-2"></i>API Endpoint Created!</h6>';
            html += '<div class="alert alert-success">';
            html += '<h6>üöÄ REST API Deployed:</h6>';
            html += '<p><strong>Endpoint:</strong> <code>POST /api/predict</code></p>';
            html += '<p><strong>Example Request:</strong></p>';
            html += '<pre class="bg-light p-2"><code>{';
            html += '  "sqft": 1500,';
            html += '  "bedrooms": 3,';
            html += '  "age": 5';
            html += '}</code></pre>';
            html += '<p><strong>Example Response:</strong></p>';
            html += '<pre class="bg-light p-2"><code>{';
            html += '  "prediction": 245000,';
            html += '  "confidence": 0.89';
            html += '}</code></pre>';
            html += '</div>';
            
            document.getElementById('deploymentResult').innerHTML = html;
        }

        async function createWebInterface() {
            let html = '<h6><i class="fas fa-globe text-success me-2"></i>Web Interface Created!</h6>';
            html += '<div class="alert alert-info">';
            html += '<h6>üåê Web Interface Deployed:</h6>';
            html += '<p><strong>URL:</strong> <code>http://localhost:5000/predict</code></p>';
            html += '<div class="border p-3 bg-light">';
            html += '<h6>House Price Predictor</h6>';
            html += '<div class="mb-2">';
            html += '<label class="form-label">Square Feet:</label>';
            html += '<input type="number" class="form-control" placeholder="1500">';
            html += '</div>';
            html += '<div class="mb-2">';
            html += '<label class="form-label">Bedrooms:</label>';
            html += '<input type="number" class="form-control" placeholder="3">';
            html += '</div>';
            html += '<div class="mb-2">';
            html += '<label class="form-label">Age:</label>';
            html += '<input type="number" class="form-control" placeholder="5">';
            html += '</div>';
            html += '<button class="btn btn-primary">Predict Price</button>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('deploymentResult').innerHTML = html;
        }

        async function createPythonScript() {
            let html = '<h6><i class="fas fa-file-code text-success me-2"></i>Python Script Generated!</h6>';
            html += '<div class="alert alert-warning">';
            html += '<h6>üêç Standalone Prediction Script:</h6>';
            html += '<pre class="bg-light p-2"><code>import joblib';
            html += 'import pandas as pd';
            html += '';
            html += '# Load trained model';
            html += 'model = joblib.load("best_model.pkl")';
            html += '';
            html += 'def predict_price(sqft, bedrooms, age):';
            html += '    data = pd.DataFrame({';
            html += '        "sqft": [sqft],';
            html += '        "bedrooms": [bedrooms],';
            html += '        "age": [age]';
            html += '    })';
            html += '    return model.predict(data)[0]';
            html += '';
            html += '# Example usage';
            html += 'price = predict_price(1500, 3, 5)';
            html += 'print(f"Predicted price: ${price:,.0f}")</code></pre>';
            html += '</div>';
            
            document.getElementById('deploymentResult').innerHTML = html;
        }

        async function createDockerContainer() {
            let html = '<h6><i class="fas fa-docker text-success me-2"></i>Docker Container Created!</h6>';
            html += '<div class="alert alert-info">';
            html += '<h6>üê≥ Docker Deployment:</h6>';
            html += '<p><strong>Dockerfile:</strong></p>';
            html += '<pre class="bg-light p-2"><code>FROM python:3.9-slim';
            html += 'COPY requirements.txt .';
            html += 'RUN pip install -r requirements.txt';
            html += 'COPY model.pkl .';
            html += 'COPY app.py .';
            html += 'EXPOSE 5000';
            html += 'CMD ["python", "app.py"]</code></pre>';
            html += '<p><strong>Build Command:</strong> <code>docker build -t ml-model .</code></p>';
            html += '<p><strong>Run Command:</strong> <code>docker run -p 5000:5000 ml-model</code></p>';
            html += '</div>';
            
            document.getElementById('deploymentResult').innerHTML = html;
        }

        async function testPredictions() {
            let html = '<h6><i class="fas fa-play text-success me-2"></i>Prediction Test Results</h6>';
            html += '<div class="alert alert-success">';
            html += '<h6>‚úÖ Test Predictions:</h6>';
            html += '<table class="table table-sm">';
            html += '<thead><tr><th>Input</th><th>Predicted</th><th>Actual</th><th>Error</th></tr></thead>';
            html += '<tbody>';
            html += '<tr><td>1500 sqft, 3 bed, 5 age</td><td>$245,000</td><td>$240,000</td><td>2.1%</td></tr>';
            html += '<tr><td>2000 sqft, 4 bed, 2 age</td><td>$285,000</td><td>$290,000</td><td>1.7%</td></tr>';
            html += '<tr><td>1200 sqft, 2 bed, 8 age</td><td>$195,000</td><td>$200,000</td><td>2.5%</td></tr>';
            html += '</tbody>';
            html += '</table>';
            html += '<p class="small"><strong>Average Error:</strong> 2.1% - Model performing well!</p>';
            html += '</div>';
            
            document.getElementById('deploymentResult').innerHTML = html;
        }

        async function monitorPerformance() {
            let html = '<h6><i class="fas fa-chart-line text-success me-2"></i>Performance Monitoring</h6>';
            html += '<div class="alert alert-info">';
            html += '<h6>üìä Production Metrics:</h6>';
            html += '<div class="row">';
            html += '<div class="col-md-6">';
            html += '<ul class="small">';
            html += '<li><strong>Requests per hour:</strong> 1,250</li>';
            html += '<li><strong>Average response time:</strong> 45ms</li>';
            html += '<li><strong>Success rate:</strong> 99.8%</li>';
            html += '<li><strong>Error rate:</strong> 0.2%</li>';
            html += '</ul>';
            html += '</div>';
            html += '<div class="col-md-6">';
            html += '<ul class="small">';
            html += '<li><strong>Model accuracy:</strong> 92.1%</li>';
            html += '<li><strong>Prediction drift:</strong> Low</li>';
            html += '<li><strong>Resource usage:</strong> 65%</li>';
            html += '<li><strong>Uptime:</strong> 99.9%</li>';
            html += '</ul>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('deploymentResult').innerHTML = html;
        }

        async function downloadArtifacts() {
            let html = '<h6><i class="fas fa-download text-success me-2"></i>Deployment Artifacts Ready!</h6>';
            html += '<div class="alert alert-success">';
            html += '<h6>üì¶ Download Package:</h6>';
            html += '<ul class="small">';
            html += '<li><strong>model.pkl</strong> - Trained model file</li>';
            html += '<li><strong>app.py</strong> - Flask API application</li>';
            html += '<li><strong>requirements.txt</strong> - Python dependencies</li>';
            html += '<li><strong>Dockerfile</strong> - Container configuration</li>';
            html += '<li><strong>README.md</strong> - Deployment instructions</li>';
            html += '<li><strong>test_data.csv</strong> - Sample test data</li>';
            html += '</ul>';
            html += '<button class="btn btn-primary btn-sm">Download ZIP</button>';
            html += '</div>';
            
            document.getElementById('deploymentResult').innerHTML = html;
        }

        async function shareModel() {
            let html = '<h6><i class="fas fa-share text-success me-2"></i>Model Sharing</h6>';
            html += '<div class="alert alert-info">';
            html += '<h6>üîó Share Your Model:</h6>';
            html += '<p><strong>Public API URL:</strong> <code>https://api.ml-lab.com/predict</code></p>';
            html += '<p><strong>Documentation:</strong> <code>https://docs.ml-lab.com/housing-predictor</code></p>';
            html += '<p><strong>GitHub Repository:</strong> <code>github.com/user/housing-predictor</code></p>';
            html += '<div class="mt-3">';
            html += '<button class="btn btn-primary btn-sm me-2">Copy API URL</button>';
            html += '<button class="btn btn-secondary btn-sm me-2">Share on GitHub</button>';
            html += '<button class="btn btn-info btn-sm">Generate QR Code</button>';
            html += '</div>';
            html += '</div>';
            
            document.getElementById('deploymentResult').innerHTML = html;
        }
    </script>
</body>
</html>
